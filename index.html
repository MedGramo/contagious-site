<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="robots" content="noindex,nofollow">
<title>Contagious ‚Äî MedGramo</title>
<style>
  :root{
    --bg:#0e1117; --panel:#151a22; --muted:#8a90a3; --text:#e8ecf3; --accent:#7aa2ff;
    --ok:#2ecc71; --bad:#ff6b6b; --warn:#ffb84d; --border:#262b36;
    --gp-bg:#1c1216; --gp-bd:#4a2a34;
    --gn-bg:#111a24; --gn-bd:#2b425c;
    --ot-bg:#122018; --ot-bd:#274a35;
    --chip:#1e2a44; --chip-t:#bed0ff;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; --header-h:64px; --toolbar-h:56px; --toolbar-h-active:var(--toolbar-h);}
  .print-only{display:none;}
  #print-snapshot{display:none;}
  header{position:sticky; top:0; z-index:5; background:linear-gradient(180deg,var(--bg),rgba(14,17,23,.94)); border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px; margin:0 auto; padding:14px 16px}
  h1{margin:0 0 8px; font-size:18px}
  .app-title{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
  .app-title .app-title-text{display:inline-flex; align-items:center; gap:6px;}
  .beta-badge{display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:var(--chip); color:var(--chip-t); font-size:11px; letter-spacing:.02em; text-transform:uppercase;}
  .coming-soon-button{border:1px solid var(--border); background:#151a22; color:var(--text); border-radius:999px; padding:4px 10px; font-size:12px; line-height:1; cursor:pointer; transition:background .15s ease, border-color .15s ease, color .15s ease;}
  .coming-soon-button:focus-visible{outline:2px solid var(--accent); outline-offset:2px;}
  .coming-soon-button:hover{background:#1b2333; border-color:color-mix(in srgb, var(--border) 70%, transparent);}
  .toolbar{display:grid; grid-template-columns:1fr; gap:8px}
  .toolbar .btn{display:inline-flex; align-items:center; gap:6px; justify-content:flex-start;}
  @media (min-width:980px){
    .toolbar{grid-template-columns:auto auto 1fr auto auto; align-items:center}
  }
  select,input[type="file"]{background:#151a22; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:9px 10px}
  .btn{border:1px solid var(--border); background:#151a22; color:var(--text); border-radius:10px; padding:9px 12px; cursor:pointer}
  .btn:active{transform:scale(.98)}
  .search{display:flex; gap:8px}
  .search input{flex:1; background:#151a22; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:9px 12px; outline:none}
  .pill{padding:6px 8px; border:1px solid var(--border); background:#151a22; border-radius:999px; color:var(--muted); font-size:12px}
  .main-scroll{width:100%;}
  .toolbar-pill{position:fixed; top:calc(12px + env(safe-area-inset-top, 0px)); right:calc(12px + env(safe-area-inset-right, 0px)); display:none; z-index:110; box-shadow:0 6px 18px rgba(0,0,0,.35);}
  .toolbar-label{display:inline-flex; align-items:center; gap:6px;}
  .toolbar-label .toolbar-icon{display:none;}
  .toolbar-icon{display:inline-flex; align-items:center; justify-content:center; line-height:1;}
  .toolbar-text{display:inline;}
  .toolbar-compact-toggle{display:none;}

  .coming-soon-layer{position:fixed; inset:0; display:none; align-items:flex-start; justify-content:center; pointer-events:auto; z-index:40;}
  .coming-soon-layer[aria-hidden="false"]{display:flex;}
  .coming-soon-layer.is-mobile{align-items:center; padding:24px;}
  .coming-soon-popover{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:18px 20px 20px; min-width:220px; max-width:min(320px, 90vw); box-shadow:0 20px 40px rgba(0,0,0,.45); pointer-events:auto; position:relative;}
  .coming-soon-popover h2{margin:0 0 12px; font-size:15px;}
  .coming-soon-popover ul{margin:0; padding-left:18px; font-size:13px; line-height:1.4;}
  .coming-soon-close{position:absolute; top:10px; right:10px; border:1px solid var(--border); background:#151a22; color:var(--text); border-radius:999px; padding:4px 8px; font-size:12px; cursor:pointer;}
  .coming-soon-close:focus-visible{outline:2px solid var(--accent); outline-offset:2px;}

  .coming-soon-layer:not(.is-mobile) .coming-soon-popover{transform-origin:top right;}

  .disclaimer-license{color:var(--chip-t); text-decoration:underline; font-weight:600;}
  .disclaimer-license:focus-visible{outline:2px solid var(--accent); outline-offset:2px; border-radius:4px;}

  @media print{
    .coming-soon-button,
    .coming-soon-layer{display:none !important;}
  }

  .clinical-loader{display:none; grid-column:1/-1; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#101828; flex-wrap:wrap; gap:10px; align-items:center}
  .clinical-loader .btn{margin:0}
  .clinical-loader input[type="file"]{display:none}
  .clinical-loader-status{margin-top:8px; font-size:12px; color:#b5e9c7; display:none; flex-basis:100%}

  .board{max-width:1200px; margin:14px auto; display:grid; gap:14px; grid-template-columns:1fr}
  @media (min-width:980px){ .board.two{grid-template-columns:1fr 1fr} }
  .col{background:#151a22; border:1px solid var(--border); border-radius:14px; padding:10px; display:flex; flex-direction:column}
  .col h2{margin:4px 6px 10px; font-size:15px}
  .list{display:flex; flex-direction:column; overflow:auto; height:68vh; min-height:300px}

  .item{border:1px solid #2a3040; border-radius:12px; padding:12px 44px 12px 12px; margin:6px; background:#0f1420; cursor:pointer; transition:.15s; position:relative}
  .item:hover{filter:brightness(1.05)}
  .item.selected{outline:2px solid var(--accent)}
  .matched{background:#0f1a15; border-color:#1f3b2c; box-shadow:0 0 0 2px rgba(46,204,113,.25) inset}
  .locked{opacity:.6; pointer-events:none}
  .dimmed{opacity:.35}

  /* contatori per-farmaco (solo Copre) */
  .counters{position:absolute; right:36px; bottom:8px; display:flex; gap:6px; align-items:center}
  .cnt{font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); color:#dfe6ff; background:#172036}
  .cnt.top{background:#182432; border-color:#2e4b78}
  .cnt.bene{background:#1b2234; border-color:#2c3d64; opacity:.95}
  .cnt.ok{background:#1b1f2a; border-color:#32364a; opacity:.9}

  /* icona info */
  .info{position:absolute; right:8px; bottom:8px; font-size:12px; color:#bcd1ff; border:1px solid #2a3040; padding:2px 6px; border-radius:6px; cursor:pointer; user-select:none}
  .info:hover{background:#1a2240}

  /* colorazione cluster */
  .cluster-gp{background:var(--gp-bg); border-color:var(--gp-bd)}
  .cluster-gn{background:var(--gn-bg); border-color:var(--gn-bd)}
  .cluster-ot{background:var(--ot-bg); border-color:var(--ot-bd)}

  .mode-bugdrug #filterCategory{display:none !important;}
  .mode-bugdrug #btnReshuffleTop{display:none !important;}

  .mode-bugdrug .cluster-card{
    background:#0f1420;
    border-color:#2a3040;
    color:var(--text);
    box-shadow:none;
    display:flex;
    align-items:center;
    gap:12px;
    padding-right:12px;
  }

  .mode-bugdrug .cluster-card .title{
    flex:1;
    min-width:0;
  }

  .mode-bugdrug .cluster-card .info{
    position:static;
    margin:0;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:28px;
    min-height:28px;
    padding:4px 8px;
    border-radius:8px;
    transition:background .15s ease, border-color .15s ease, color .15s ease;
  }

  .mode-bugdrug .cluster-card .info:hover,
  .mode-bugdrug .cluster-card .info:focus-visible{
    background:#1a2240;
    border-color:color-mix(in srgb, #1a2240 45%, transparent);
  }

  .mode-bugdrug .cluster-card.tag-gp{
    --accent:#FFD65A;
  }

  .mode-bugdrug .cluster-card.tag-gn{
    --accent:#6EA8FE;
    border-color:var(--accent);
    box-shadow:inset 4px 0 0 var(--accent);
  }

  .mode-bugdrug .cluster-card.tag-curvi,
  .mode-bugdrug .cluster-card.tag-ana-up,
  .mode-bugdrug .cluster-card.tag-ana-down{
    --accent:#C7B6FF;
  }

  .mode-bugdrug .cluster-card.tag-gp,
  .mode-bugdrug .cluster-card.tag-curvi,
  .mode-bugdrug .cluster-card.tag-ana-up,
  .mode-bugdrug .cluster-card.tag-ana-down{
    border-color:var(--accent);
    box-shadow:inset 4px 0 0 var(--accent);
  }

  .mode-bugdrug .cluster-card.tag-gp:hover,
  .mode-bugdrug .cluster-card.tag-curvi:hover,
  .mode-bugdrug .cluster-card.tag-ana-up:hover,
  .mode-bugdrug .cluster-card.tag-ana-down:hover{
    border-color:color-mix(in srgb, var(--accent) 75%, transparent);
    box-shadow:inset 6px 0 0 var(--accent);
  }

  .mode-bugdrug .cluster-card.tag-gn:hover{
    border-color:#8FB8FF;
    box-shadow:inset 6px 0 0 var(--accent);
  }

  .mode-bugdrug .cluster-card.tag-gn .info,
  .mode-bugdrug .cluster-card.tag-gn .info-icon{
    color:rgba(255,255,255,.85);
  }

  .mode-bugdrug .cluster-card.tag-gn .info:hover,
  .mode-bugdrug .cluster-card.tag-gn .info-icon:hover{
    color:#fff;
  }

  .mode-bugdrug .cluster-card .info{
    color:rgba(255,255,255,.85);
  }

  .mode-bugdrug .cluster-card .info:hover{
    color:#fff;
  }

  .mode-bugdrug .item.search-hit{
    border-color:#4a5da0;
    box-shadow:0 0 0 2px rgba(122,162,255,.35);
    background:rgba(17,24,40,.92);
  }

  .mode-bugdrug details.has-search-hit{
    border-radius:12px;
    outline:1px solid rgba(122,162,255,.25);
  }

  .mode-bugdrug details.has-search-hit > summary{
    background:rgba(122,162,255,.12);
    color:#dce6ff;
    border-radius:12px 12px 0 0;
  }

  .mode-bugdrug details.has-search-hit[open] > .group{
    border-top:1px solid rgba(122,162,255,.18);
  }

  .mode-bugdrug .item.flash-ok:not(.cluster-card){
    animation:bugdrug-flash-ok 1.5s ease-out 1;
  }

  @keyframes bugdrug-flash-ok{
    0%{box-shadow:inset 0 0 0 0 rgba(46,204,113,0);}
    20%{box-shadow:inset 0 0 0 9999px rgba(46,204,113,0.20);}
    40%{box-shadow:inset 0 0 0 0 rgba(46,204,113,0);}
    70%{box-shadow:inset 0 0 0 9999px rgba(46,204,113,0.20);}
    100%{box-shadow:inset 0 0 0 0 rgba(46,204,113,0);}
  }

  @media (prefers-reduced-motion:reduce){
    .mode-bugdrug .item.flash-ok:not(.cluster-card){animation:none;}
  }

  /* Scoping: SOLO in Bug-Drug */
  .mode-bugdrug .cluster-card.flash-ok::after{
    content:""; position:absolute; inset: 3px 3px 3px 9px; /* lascia visibile stripe sinistra e bordo */
    border-radius: calc(var(--radius, 12px) - 3px);
    background: rgba(46,204,113,0); pointer-events:none;
    animation: cluster-inner-flash 1.5s ease-out 1;
    z-index: 0;
  }
  /* Mantieni testo/icone sopra il flash */
  .mode-bugdrug .cluster-card > *{ position:relative; z-index: 1; }

  @keyframes cluster-inner-flash{
    0%   { background: rgba(46,204,113,0); }
    20%  { background: rgba(46,204,113,0.22); }
    40%  { background: rgba(46,204,113,0); }
    70%  { background: rgba(46,204,113,0.22); }
    100% { background: rgba(46,204,113,0); }
  }

  /* Accessibilit√†: rispetta chi riduce le animazioni */
  @media (prefers-reduced-motion: reduce){
    .mode-bugdrug .cluster-card.flash-ok::after { animation:none; }
  }

  .warnbox{max-width:1200px; margin:8px auto 0; padding:10px 12px; border:1px solid #5a4b24; background:#2c2412; color:#f6d28b; border-radius:10px; display:none}
  .error{max-width:1200px; margin:10px auto 0; padding:10px 12px; border:1px solid #553; background:#2a1414; color:#f1c3c3; border-radius:10px; display:none}
  .foot{max-width:1200px; margin:14px auto 32px; color:var(--muted); font-size:12px; padding:0 16px}
  .app-disclaimer{max-width:1200px; margin:0 auto 36px; padding:12px 16px; font-size:12px; line-height:1.5; color:var(--muted); background:rgba(15,20,32,.75); border:1px solid var(--border); border-radius:12px}

  /* accordion */
  details{border:1px solid #2a3040; border-radius:12px; margin:6px; background:#0f1420}
  summary{cursor:pointer; padding:10px 12px; font-weight:600}
  .group{padding:6px 10px 10px}
  .clinical-group > .group{padding:6px 10px 12px}
  .clinical-subgroup{border:1px solid #2a3040; border-radius:10px; margin:6px 0; background:#101828}
  .clinical-subgroup summary{padding:8px 10px; font-size:13px}
  .clinical-subgroup-items{padding:6px 8px 10px}
  .clinical-subgroup-items .item{margin:6px 2px 0}
  .clinical-subgroup-items .item:first-child{margin-top:0}

  /* Modal soluzioni */
  .modal{position:fixed; inset:0; display:none; z-index:10000}
  .modal.show{display:block}
  .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55)}
  .card{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); max-width:720px; width:92vw; background:#0f1420; border:1px solid var(--border); border-radius:12px; padding:14px}
  .card h3{margin:0 0 8px}
  .chips .chip{display:inline-block; margin:4px 6px 0 0; padding:4px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:#c9d2f0}
  .case-actions{margin-top:10px; display:flex; flex-wrap:wrap; gap:8px}
  .case-actions + .case-actions{margin-top:8px}
  #clin-slots{margin-top:12px; border:1px solid var(--border); border-radius:12px; background:#101828; padding:12px; position:relative; display:flex; flex-direction:column; gap:10px}
  #clin-slots::after{content:''; position:absolute; inset:0; border-radius:12px; pointer-events:none; box-shadow:0 0 0 1px rgba(122,162,255,.06) inset}
  .clin-slot-banner{display:none; align-self:flex-start; background:#13221a; color:#b5e9c7; border:1px solid #1f3b2c; border-radius:999px; padding:4px 10px; font-weight:600; font-size:13px}
  .clin-slot-list{display:flex; flex-direction:column; gap:8px}
  .clin-slot{display:flex; align-items:center; gap:10px; border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#111726; color:#cdd7f2; transition:background .2s, border-color .2s, color .2s}
  .clin-slot.empty{color:#707897; background:#111726}
  .clin-slot.empty .clin-slot-bullet{color:#4b5168}
  .clin-slot.empty .clin-slot-label{display:none}
  .clin-slot.filled{background:#13221a; border-color:#1f3b2c; color:#b5e9c7}
  .clin-slot.filled .clin-slot-bullet{color:#b5e9c7}
  .clin-slot.locked{opacity:.92; pointer-events:none}
  .clin-slot-bullet{font-size:18px; color:var(--accent)}
  .clin-slot-label{flex:1; font-weight:600; font-size:13px}
  .clin-slot-empty-message{color:#7f89a8; font-size:13px; padding:10px 0}
  #clin-notes{margin-top:10px; border:1px solid var(--border); border-radius:12px; background:#101828; padding:10px 12px; font-size:13px; color:#cfe0ff; display:none}
  #clin-notes ul{margin:4px 0 0; padding-left:18px; list-style:disc}
  #clin-notes li{margin:4px 0; line-height:1.4}
  .item .subtitle{margin-top:4px; color:#9fb0d0; font-size:12px}
  .solution-list{margin:10px 0 0; padding-left:18px; list-style:disc; line-height:1.5}
  .solution-list li{margin:6px 0}
  .case-vignette{margin-top:6px; line-height:1.5}
  .compat-section{margin-top:12px}
  .compat-section h4{margin:0 0 6px; color:#9fb5ff; font-size:13px}
  .compat-section ul{margin:0; padding-left:18px; list-style:disc; color:#d0d8f4; font-size:13px}
  .compat-section li{margin:4px 0}
  .compat-clusters{display:block; color:#9fb0d0; font-size:12px}
  .compat-reason{display:block; color:#f1c3c3; font-size:12px; margin-top:2px}
  .compat-empty{color:#7f89a8; font-size:12px; margin:4px 0}
  .case-solution-text{margin-bottom:12px; line-height:1.55}
  .rec-block{border:1px solid #2a3040; border-radius:10px; padding:10px 12px; margin-top:10px; background:#101828}
  .rec-block:first-of-type{margin-top:0}
  .rec-block strong{color:#cfe0ff}
  .rec-block small{color:#9fb0d0}

  /* Toast centrale */
  .toast-wrap{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:11000}
  .toast{background:#101828; border:1px solid var(--border); color:#fff; padding:12px 16px; border-radius:10px; font-weight:700; opacity:0; transform:translateY(-6px); transition:opacity .15s, transform .15s; white-space:pre-line}
  .toast.show{opacity:1; transform:translateY(0)}
  .toast.ok{background:#12261a; color:#b5e9c7; border-color:#1f3b2c}
  .toast.bad{background:#2a1414; color:#f0c1c1; border-color:#553333}
  .toast.mid{background:#1b2337; color:#cfe0ff; border-color:#2a365f}

  /* Impara */
  .mode-impara .learn-table-wrap{overflow:auto; height:68vh; border:1px solid #232a38; border-radius:8px; background:#121722; box-shadow:0 12px 30px rgba(0,0,0,.3) inset;}
  .mode-impara .learn-table{width:100%; border-collapse:collapse; min-width:720px; color:var(--text);}
  .mode-impara .learn-table thead th{position:sticky; top:0; background:rgba(24,30,44,.92); color:#f2f5ff; text-align:left;}
  .mode-impara .learn-table th,
  .mode-impara .learn-table td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); vertical-align:top;}
  .mode-impara .learn-table tbody tr:nth-child(odd){background:rgba(255,255,255,.02);}
  .mode-impara .learn-table tbody tr:nth-child(even){background:rgba(255,255,255,.07);}
  .mode-impara .learn-table tbody tr:hover{background:rgba(148,173,255,.12);}
  .mode-impara .learn-table td b{color:#ffffff;}
  .mode-impara .learn-table td small{color:#9fb0d0;}
  .mode-impara .learn-table td br+small{display:inline-block; margin-top:2px;}
  .mode-impara .learn-table td:last-child{min-width:180px;}
  .mode-impara .board .col:last-child{display:none;}

  #btnPrintPDF,
  #btnLearnInfo{display:none;}
  .mode-impara #btnPrintPDF,
  .mode-impara #btnLearnInfo{display:inline-flex; align-items:center; gap:6px; background:#202a3f; color:#dce6ff; border:1px solid rgba(255,255,255,.1);}
  .mode-impara #btnPrintPDF:hover,
  .mode-impara #btnPrintPDF:focus-visible,
  .mode-impara #btnLearnInfo:hover,
  .mode-impara #btnLearnInfo:focus-visible{background:#2b3752; color:#fff;}
  .mode-impara #filterCategory,
  .mode-impara #filterCluster,
  .mode-impara #btnReshuffleTop,
  .mode-impara #btnReset,
  .mode-impara #fileDrugs,
  .mode-impara .clinical-loader{display:none !important;}

  .mode-impara .toolbar{gap:10px; flex-wrap:wrap;}
  .mode-impara .toolbar > *:not(.search):not(#btnPrintPDF):not(#btnLearnInfo):not(#btnFeedback):not(.pill):not(#modeSelect){display:none;}
  .mode-impara .toolbar .pill,
  .mode-impara .toolbar #modeSelect{order:-1;}
  .mode-impara .search{flex:1 1 260px;}
  .mode-impara #btnPrintPDF{order:1;}
  .mode-impara #btnLearnInfo{order:2;}
  .mode-impara #btnFeedback{order:3;}
  .learn-info-popover{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1200; padding:24px; background:rgba(6,8,12,.55);}
  .learn-info-popover.show{display:flex;}
  .learn-info-card{max-width:360px; width:100%; background:#182237; color:#dce6ff; border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:18px 20px; box-shadow:0 20px 48px rgba(0,0,0,.45);}
  .learn-info-card h3{margin:0 0 10px; font-size:16px; color:#f0f4ff;}
  .learn-info-card p{margin:0 0 10px; font-size:13px; color:#d2dcff;}
  .learn-info-card ul{margin:0; padding-left:18px; color:#c7d4ff; font-size:13px; line-height:1.5;}
  .learn-info-card button{margin-top:14px; background:#202a3f; color:#dce6ff; border:1px solid rgba(255,255,255,.16); border-radius:8px; padding:7px 12px; cursor:pointer;}
  .learn-info-card button:hover,
  .learn-info-card button:focus-visible{background:#2b3752; color:#fff;}

  @media (max-width:860px){
    .mode-impara .learn-table{min-width:0;}
  }

  @media print{
    @page{size:A4 portrait; margin:12mm 10mm 16mm;}
    #btnFeedback{display:none !important;}
    .toolbar-pill{display:none !important;}
    html{height:auto !important; min-height:0 !important;}
    body.print-snapshot-active{
      background:#fff;
      color:#000;
      font:13px/1.45 "Helvetica Neue",Arial,sans-serif;
      padding:0;
      box-shadow:none;
      -webkit-print-color-adjust:exact;
      print-color-adjust:exact;
      min-height:0 !important;
    }
    body.print-snapshot-active > *:not(#print-snapshot){display:none !important;}
    body.print-snapshot-active #print-snapshot{display:block !important; margin:0 !important; padding:0 !important;}
    body.print-snapshot-active #print-snapshot,
    body.print-snapshot-active #print-snapshot *,
    body.print-snapshot-active #print-snapshot table{height:auto !important; max-height:none !important; overflow:visible !important;}
    body.print-snapshot-active #print-snapshot{
      -webkit-print-color-adjust:exact;
      print-color-adjust:exact;
      background:#fff;
      color:#000;
    }
    body.print-snapshot-active #print-snapshot table{
      width:100% !important;
      border-collapse:collapse !important;
      border-spacing:0 !important;
      background:#fff;
      color:#000;
      page-break-inside:auto;
      break-inside:auto;
      border:1px solid #c5ccd8;
    }
    body.print-snapshot-active #print-snapshot thead{display:table-header-group;}
    body.print-snapshot-active #print-snapshot tfoot{display:table-footer-group;}
    body.print-snapshot-active #print-snapshot tr,
    body.print-snapshot-active #print-snapshot th,
    body.print-snapshot-active #print-snapshot td{page-break-inside:avoid; break-inside:avoid;}
    body.print-snapshot-active #print-snapshot th,
    body.print-snapshot-active #print-snapshot td{
      padding:9px 12px;
      border-bottom:1px solid #d5dbe4;
      color:#000;
      vertical-align:top;
      white-space:normal !important;
      word-break:break-word;
      overflow-wrap:anywhere;
      -webkit-print-color-adjust:exact;
      print-color-adjust:exact;
    }
    body.print-snapshot-active #print-snapshot thead tr:not(.print-snapshot-title) th{
      background:#f4f4f4;
      border-bottom:1px solid #c8ced8;
      font-weight:700;
    }
    body.print-snapshot-active #print-snapshot .print-snapshot-title th{
      background:#fff;
      border-bottom:1px solid #c8ced8;
      font-size:12px;
      letter-spacing:.02em;
    }
    body.print-snapshot-active #print-snapshot tbody tr:nth-child(odd){background:#fff;}
    body.print-snapshot-active #print-snapshot tbody tr:nth-child(even){background:#f1f1f1;}
    body.print-snapshot-active #print-snapshot tbody tr:hover{background:transparent;}
    body.print-snapshot-active #print-snapshot td small{color:#333;}
    body.print-snapshot-active #print-snapshot td b{color:#000;}
    body.print-snapshot-active #print-snapshot td:last-child{min-width:180px;}
    body.print-snapshot-active #print-snapshot tfoot td{
      padding:8px 12px;
      border-top:1px solid #c8ced8;
      font-size:9px;
      line-height:1.45;
      font-weight:600;
      color:#333;
      background:#fff;
      white-space:normal !important;
      word-break:break-word;
      overflow-wrap:anywhere;
    }
    body.mode-impara{background:#fff; color:#000; font:13px/1.45 "Helvetica Neue",Arial,sans-serif; padding:0; box-shadow:none; -webkit-print-color-adjust:exact; print-color-adjust:exact; min-height:0 !important;}
    body.mode-impara header,
    body.mode-impara .toolbar,
    body.mode-impara #warnBox,
    body.mode-impara #errorBox,
    body.mode-impara .toast-wrap,
    body.mode-impara .foot,
    body.mode-impara .app-disclaimer,
    body.mode-impara #modal,
    body.mode-impara #backdrop,
    body.mode-impara .learn-info-popover,
    body.mode-impara #btnLearnInfo,
    body.mode-impara #btnFeedback{display:none !important;}
    body.mode-impara header,
    body.mode-impara header *,
    body.mode-impara .wrap,
    body.mode-impara #board,
    body.mode-impara .board,
    body.mode-impara .board .col,
    body.mode-impara .board .list,
    body.mode-impara .learn-table-wrap{position:static !important; top:auto !important; height:auto !important; max-height:none !important; min-height:0 !important; overflow:visible !important;}
    body.mode-impara .wrap{padding:0 !important; margin:0 auto !important;}
    body.mode-impara .board{display:block !important; margin:0; padding:0; background:none; box-shadow:none; max-width:none; width:100%;}
    body.mode-impara .board.two{grid-template-columns:none;}
    body.mode-impara .board .col{display:block; width:100%; max-width:none; padding:0; margin:0; border:none; background:none; box-shadow:none; overflow:visible !important; height:auto !important;}
    body.mode-impara .board .col + .col{display:none;}
    body.mode-impara .board h2{display:none !important;}
    body.mode-impara .list{display:block; padding:0 !important; margin:0 !important; width:100%;}
    body.mode-impara .learn-table-wrap{display:block; border:1px solid #c5ccd8; border-radius:6px; background:#fff; box-shadow:none; margin:0; width:100%; padding:0 !important;}
    body.mode-impara .learn-table{width:100% !important; min-width:0; border-collapse:collapse !important; border-spacing:0 !important; background:#fff; color:#000; page-break-inside:auto; break-inside:auto; table-layout:auto;}
    body.mode-impara .learn-table thead{display:table-header-group;}
    body.mode-impara .learn-table thead tr{break-inside:avoid; page-break-inside:avoid;}
    body.mode-impara .learn-table thead th{position:static !important; top:auto !important; background:#f4f4f4; color:#000; border-bottom:1px solid #c8ced8; font-weight:700; -webkit-print-color-adjust:exact; print-color-adjust:exact;}
    body.mode-impara .learn-table tr{page-break-inside:avoid; break-inside:avoid;}
    body.mode-impara .learn-table th,
    body.mode-impara .learn-table td{padding:9px 12px; border-bottom:1px solid #d5dbe4; color:#000; vertical-align:top; word-break:break-word; white-space:normal !important; overflow-wrap:anywhere; page-break-inside:avoid; break-inside:avoid;}
    body.mode-impara .learn-table tbody{display:table-row-group;}
    body.mode-impara .learn-table tbody tr{break-inside:avoid; page-break-inside:avoid;}
    body.mode-impara .learn-table tfoot tr{break-inside:avoid; page-break-inside:avoid;}
    body.mode-impara .learn-table tbody tr:nth-child(odd){background:#fff; -webkit-print-color-adjust:exact; print-color-adjust:exact;}
    body.mode-impara .learn-table tbody tr:nth-child(even){background:#f1f1f1; -webkit-print-color-adjust:exact; print-color-adjust:exact;}
    body.mode-impara .learn-table tbody tr:hover{background:transparent;}
    body.mode-impara .learn-table td small{color:#333;}
    body.mode-impara .learn-table td b{color:#000;}
    body.mode-impara .learn-table td:last-child{min-width:180px;}
    body.mode-impara .learn-table thead .print-only th{background:#fff; border-bottom:1px solid #c8ced8; font-size:12px; letter-spacing:.02em;}
    body.mode-impara .learn-table tr.print-only{display:table-row !important;}
    body.mode-impara .learn-table tfoot{display:table-footer-group !important;}
    body.mode-impara .learn-table tfoot td{padding:8px 12px; border-top:1px solid #c8ced8; font-size:9px; line-height:1.45; font-weight:600; color:#333; background:#fff; white-space:normal !important; word-break:break-word; overflow-wrap:anywhere; -webkit-print-color-adjust:exact; print-color-adjust:exact;}
  }

  @media (max-width:1024px) and (orientation:portrait){
    .rotate-hint{display:flex; align-items:center; gap:10px; margin:10px 0 0; padding:6px 10px; border-radius:10px; background:rgba(122,162,255,.12); border:1px solid rgba(122,162,255,.2); color:#dce6ff; font-size:13px; line-height:1.35;}
    .rotate-hint span{flex:1; min-width:0;}
    .rotate-hint-dismiss{background:none; border:none; color:#9fb5ff; font-size:13px; padding:0; cursor:pointer; text-decoration:underline;}
    .rotate-hint-dismiss:focus-visible{outline:2px solid rgba(122,162,255,.4); outline-offset:2px; border-radius:4px;}
  }

  @media (max-width:1024px) and (orientation:landscape){
    body:not(.mode-impara) .board{grid-template-columns:minmax(0,1fr) minmax(0,1fr); gap:12px;}
    body:not(.mode-impara) .board .col{min-width:0; max-width:100%; max-height:calc(100svh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,56px)) - 16px); max-height:calc(100dvh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,56px)) - 16px); overflow:auto; -webkit-overflow-scrolling:touch; scrollbar-gutter:stable both-edges;}
    body:not(.mode-impara) .board .col, body:not(.mode-impara) .board .list{overflow-x:hidden;}
    body:not(.mode-impara) .board .col h2{margin-bottom:8px;}
    body:not(.mode-impara) .board .list{height:auto; min-height:0; max-height:none; flex:1; word-break:break-word;}
    body:not(.mode-impara) .board .item{word-break:break-word;}
  }

  @media (max-width:1024px) and (orientation:landscape){
    @supports not (height:100dvh){
      body:not(.mode-impara) .board .col{max-height:calc(100vh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,56px)) - 16px);}
    }
  }

  @media (max-width:740px) and (orientation:landscape),
         (max-height:460px) and (orientation:landscape){
    body{--toolbar-h:48px; --toolbar-h-active:var(--toolbar-h); overflow:hidden;}
    body.toolbar-compact-active{--toolbar-h-active:var(--toolbar-h-compact, var(--toolbar-h,48px));}
    body.toolbar-hidden{--toolbar-h-active:0px;}
    header .wrap{padding-top:calc(10px + env(safe-area-inset-top,0px)); padding-bottom:12px;}
    .main-scroll{display:flex; flex-direction:column; min-height:0; height:calc(100svh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,48px)) - env(safe-area-inset-bottom,0px)); overflow:auto; -webkit-overflow-scrolling:touch; padding-bottom:calc(env(safe-area-inset-bottom,0px) + 12px);}
    @supports (height:100dvh){
      .main-scroll{height:calc(100dvh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,48px)) - env(safe-area-inset-bottom,0px));}
    }
    @supports not (height:100svh){
      .main-scroll{height:calc(100vh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,48px)) - env(safe-area-inset-bottom,0px));}
    }
    .toolbar{grid-template-columns:minmax(0,1fr) minmax(0,1fr) auto; gap:6px; align-items:stretch;}
    .toolbar-compact-toggle{display:inline-flex; align-items:center; justify-content:center; padding:6px 10px; min-height:40px; font-size:13px; line-height:1.3; border-radius:8px; gap:4px;}
    .toolbar-compact-toggle .toolbar-icon{font-size:16px;}
    body.toolbar-compact-active .toolbar{overflow:hidden; transition:height .28s ease, opacity .2s ease, transform .28s ease; transform-origin:top;}
    .toolbar > *{min-width:0;}
    .toolbar .pill{padding:4px 8px; font-size:11px; line-height:1.2; align-self:center;}
    .toolbar select,
    .toolbar input[type="file"],
    .toolbar .btn{padding:6px 10px; min-height:40px; font-size:14px; line-height:1.3; border-radius:8px;}
    .toolbar .search input{padding:6px 10px; min-height:40px; font-size:16px; line-height:1.3; border-radius:8px;}
    .toolbar .btn{display:inline-flex; align-items:center; justify-content:center; text-align:center; white-space:normal;}
    .toolbar select{width:100%;}
    .toolbar input[type="file"]{width:100%;}
    .toolbar .search{grid-column:1/-1; gap:6px;}
    .toolbar .clinical-loader{grid-column:1/-1; gap:8px; padding:8px 10px;}
    .toolbar .clinical-loader .btn{min-height:40px;}
    .toolbar #btnFeedback{grid-column:1/-1;}
    body.toolbar-hidden .toolbar{opacity:0; pointer-events:none; transform:translateY(-8px);}
    .toolbar-pill{position:fixed; top:calc(env(safe-area-inset-top,0px) + 10px); right:calc(env(safe-area-inset-right,0px) + 12px); z-index:110; display:none; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; border:1px solid var(--border); background:rgba(21,26,34,.88); color:var(--muted); font-size:13px; font-weight:600; letter-spacing:.01em; text-transform:none;}
    .toolbar-pill:focus-visible{outline:2px solid rgba(122,162,255,.45); outline-offset:2px;}
    body.toolbar-hidden .toolbar-pill{display:flex;}
    @supports (backdrop-filter:blur(6px)){
      .toolbar-pill{backdrop-filter:blur(6px);}
    }
    body:not(.mode-impara) .board{gap:6px; grid-template-columns:minmax(0,1fr) minmax(0,1fr);}
    body:not(.mode-impara) .board .col{min-width:0; max-width:100%; max-height:calc(100svh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,48px)) - env(safe-area-inset-bottom,0px) - 12px); max-height:calc(100dvh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,48px)) - env(safe-area-inset-bottom,0px) - 12px); overflow:auto; -webkit-overflow-scrolling:touch; scrollbar-gutter:stable both-edges;}
    body:not(.mode-impara) .board .col h2{margin-bottom:6px;}
    body:not(.mode-impara) .board .list{overflow:auto; -webkit-overflow-scrolling:touch;}
    @supports not (height:100svh){
      body:not(.mode-impara) .board .col{max-height:calc(100vh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,48px)) - env(safe-area-inset-bottom,0px) - 12px);}
    }
    body.mode-impara .toolbar{grid-template-columns:repeat(2,minmax(0,1fr)); gap:6px;}
    body.mode-impara .toolbar #btnPrintPDF,
    body.mode-impara .toolbar #btnLearnInfo,
    body.mode-impara .toolbar #btnFeedback{grid-column:1/-1;}
    body.mode-impara .learn-table-wrap{max-height:calc(100svh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,48px)) - 12px); max-height:calc(100dvh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,48px)) - 12px); overflow:auto; -webkit-overflow-scrolling:touch;}
    @supports not (height:100svh){
      body.mode-impara .learn-table-wrap{max-height:calc(100vh - var(--header-h,64px) - var(--toolbar-h-active, var(--toolbar-h,48px)) - 12px);}
    }
    body.mode-impara .learn-table{min-width:0;}
    .toolbar.toolbar--compact{gap:4px; padding:2px 0;}
    .toolbar.toolbar--compact .toolbar-label{position:relative; justify-content:center;}
    .toolbar.toolbar--compact .toolbar-label .toolbar-icon{display:inline-flex;}
    .toolbar.toolbar--compact .toolbar-text{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; border:0;}
    .toolbar.toolbar--compact .btn,
    .toolbar.toolbar--compact select,
    .toolbar.toolbar--compact input[type="file"],
    .toolbar.toolbar--compact .search input,
    .toolbar.toolbar--compact .toolbar-compact-toggle{padding:4px 6px;}
    .toolbar.toolbar--compact .btn,
    .toolbar.toolbar--compact .toolbar-compact-toggle{gap:0;}
    .toolbar.toolbar--compact .btn .toolbar-icon,
    .toolbar.toolbar--compact .toolbar-compact-toggle .toolbar-icon{font-size:18px;}
    .toolbar.toolbar--compact .btn,
    .toolbar.toolbar--compact .toolbar-compact-toggle{justify-content:center;}
  }

  @media (max-width:740px) and (orientation:landscape) and (prefers-reduced-motion:reduce),
         (max-height:460px) and (orientation:landscape) and (prefers-reduced-motion:reduce){
    body.toolbar-compact-active .toolbar{transition:none;}
  }

  .mode-clinica #btnReshuffleTop,
  .mode-clinica #filterCategory,
  .mode-clinica #filterCluster{display:none !important;}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <h1 class="app-title">
      <span class="app-title-text">Contagious ü¶†üíä¬©</span>
      <span class="beta-badge" aria-label="versione beta">Œ≤-version</span>
      <button type="button" id="comingSoonButton" class="coming-soon-button" aria-haspopup="dialog" aria-expanded="false">Coming soon</button>
    </h1>
    <div class="toolbar">
      <label class="pill toolbar-label" for="modeSelect"><span class="toolbar-icon" aria-hidden="true">üéöÔ∏è</span><span class="toolbar-text">Modalit√†</span></label>
      <select id="modeSelect">
        <option value="covers">Bug-Drug</option>
        <option value="clinical">Clinica</option>
        <option value="learn">Impara</option>
      </select>

      <div class="search"><input id="searchInput" type="search" placeholder="Cerca farmaco/categoria/cluster‚Ä¶"/></div>
      <select id="filterCategory"><option value="">Categoria farmaco: tutte</option></select>
      <select id="filterCluster"><option value="">Cluster: tutti</option></select>

      <!-- unico "Sfoglia" per i farmaci; loader clinico dedicato -->
      <input id="fileDrugs" class="btn-sfoglia" type="file" accept="application/json,.json" title="Carica farmaci JSON" />
      <div id="clinicalLoader" class="clinical-loader">
        <button type="button" class="btn" id="btnLoadClinical">Carica ./data/clinical.json (Clinica)</button>
        <input id="fileCases" class="btn-sfoglia" type="file" accept="application/json,.json" title="Carica ./data/clinical.json (Clinica)" />
        <div id="clinicalStatus" class="clinical-loader-status"></div>
      </div>

      <!-- üëÄ Soluzioni rimosso -->
      <button class="btn" id="btnReshuffleTop" type="button" aria-label="Reshuffle" title="Reshuffle"><span class="toolbar-icon" aria-hidden="true">üîÅ</span><span class="toolbar-text">Reshuffle</span></button>
      <button class="btn" id="btnReset" type="button" aria-label="Reset" title="Reset"><span class="toolbar-icon" aria-hidden="true">üßπ</span><span class="toolbar-text">Reset</span></button>
      <a class="btn" id="btnFeedback" href="https://forms.gle/8vPSVRSj8ResCwZZ9" target="_blank" rel="noopener noreferrer" aria-label="Lascia un feedback!" title="Lascia un feedback!"><span class="toolbar-icon" aria-hidden="true">üìù</span><span class="toolbar-text">Lascia un feedback!</span></a>
      <button class="btn" id="btnPrintPDF" type="button" aria-label="Stampa PDF" title="Stampa PDF"><span class="toolbar-icon" aria-hidden="true">üñ®Ô∏è</span><span class="toolbar-text">Stampa PDF</span></button>
      <button class="btn" id="btnLearnInfo" type="button" aria-label="Info" title="Info"><span class="toolbar-icon" aria-hidden="true">‚ÑπÔ∏è</span><span class="toolbar-text">Info</span></button>
    </div>
    <div class="rotate-hint" hidden>
      <span>üîÑ Ruota il dispositivo per vedere i pannelli affiancati.</span>
      <button type="button" class="rotate-hint-dismiss" aria-label="Nascondi suggerimento">[Nascondi]</button>
    </div>
  </div>
</header>

<button type="button" id="toolbarPill" class="toolbar-pill" hidden aria-label="Apri toolbar">‚â° Toolbar</button>

<div id="comingSoonLayer" class="coming-soon-layer" role="presentation" aria-hidden="true" hidden>
  <div id="comingSoonPopover" class="coming-soon-popover" role="dialog" aria-modal="true" aria-labelledby="comingSoonTitle" tabindex="-1">
    <button type="button" id="comingSoonClose" class="coming-soon-close" aria-label="Chiudi">‚úï</button>
    <h2 id="comingSoonTitle">In arrivo</h2>
    <ul>
      <li><strong>Nuovi farmaci:</strong> Antivirali, Antifungini, Antiparassitari</li>
      <li><strong>Nuovi casi clinici</strong></li>
      <li><strong>Nuove modalit√†</strong> (Statistiche personalizzate e molto altro!)</li>
    </ul>
  </div>
</div>

<div id="mainScroll" class="main-scroll">
  <div id="warnBox" class="warnbox"></div>
  <div id="errorBox" class="error"></div>
  <div id="dataError" hidden style="max-width:1200px;margin:8px auto 0;padding:8px 12px;border:1px solid #553;background:#2a1414;color:#f1c3c3;border-radius:8px;font-size:13px;">Impossibile caricare i dati automatici. Usa i pulsanti ‚ÄúSfoglia‚Äù.</div>

  <div id="board" class="board two">
    <section class="col"><h2 id="leftTitle">Farmaci</h2><div id="leftList" class="list"></div></section>
    <section class="col"><h2 id="rightTitle">Cluster</h2><div id="rightList" class="list"></div></section>
  </div>

  <p class="foot">‚ìò Clic sull‚Äôicona <b>‚ìò</b> in una card per vedere la ‚ÄúSoluzione‚Äù.</p>

  <footer id="appDisclaimer" class="app-disclaimer" role="contentinfo"></footer>
</div>

<!-- Modal soluzioni -->
<div id="modal" class="modal" aria-hidden="true">
  <div id="backdrop" class="backdrop"></div>
  <div class="card" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Soluzione</h3>
    <div id="modalBody"></div>
  </div>
</div>

<!-- Toast centrale -->
<div class="toast-wrap"><div id="toast" class="toast"></div></div>

<!-- Popover informazioni stampa (Impara) -->
<div id="learnInfoPopover" class="learn-info-popover" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="learn-info-card">
    <h3>Informazioni stampa</h3>
    <p>Per una stampa corretta:</p>
    <ul>
      <li>Disattiva <em>Intestazioni e pi√® di pagina</em> nel dialog di stampa del browser.</li>
      <li>Seleziona <em>Tutte le pagine</em>.</li>
      <li>Orientamento: <em>Verticale</em>.</li>
      <li>Margini: <em>Default</em> (o <em>Nessuno</em>, se serve pi√π spazio).</li>
    </ul>
    <button type="button" id="btnLearnInfoClose">Chiudi</button>
  </div>
</div>

<script>
(()=>{
  const WIDTH_LIMIT = 1024;
  const ORIENTATION_QUERY = window.matchMedia('(orientation: landscape)');
  const storageKey = 'rotateHintDismissed';
  const body = document.body;
  const header = document.querySelector('header');
  const toolbar = header ? header.querySelector('.toolbar') : null;
  const rotateHint = document.querySelector('.rotate-hint');
  const dismissBtn = rotateHint ? rotateHint.querySelector('.rotate-hint-dismiss') : null;

  const getStorage = ()=>{
    try {
      return window.localStorage || null;
    } catch (err){
      return null;
    }
  };

  const updateDimensions = ()=>{
    if (!body) return;
    const hintVisible = rotateHint && !rotateHint.hasAttribute('hidden');
    const headerHeight = header ? header.offsetHeight : 0;
    const toolbarHeight = toolbar ? toolbar.offsetHeight : 0;
    let hintHeight = 0;
    if (hintVisible && rotateHint){
      const styles = window.getComputedStyle(rotateHint);
      const mt = Number.parseFloat(styles?.marginTop || '0') || 0;
      const mb = Number.parseFloat(styles?.marginBottom || '0') || 0;
      hintHeight = rotateHint.offsetHeight + mt + mb;
    }
    const headerTop = Math.max(0, headerHeight - toolbarHeight - hintHeight);
    const toolbarTotal = toolbarHeight + hintHeight;
    body.style.setProperty('--header-h', `${headerTop}px`);
    body.style.setProperty('--toolbar-h', `${toolbarTotal}px`);
  };

  const shouldShowHint = ()=>{
    if (!rotateHint) return false;
    if (body && body.classList.contains('mode-impara')) return false;
    if (ORIENTATION_QUERY.matches) return false;
    if (window.innerWidth > WIDTH_LIMIT) return false;
    const storage = getStorage();
    return !storage || storage.getItem(storageKey) !== '1';
  };

  const applyOrientation = ()=>{
    if (body){
      body.setAttribute('data-orientation', ORIENTATION_QUERY.matches ? 'landscape' : 'portrait');
    }
    if (rotateHint){
      if (shouldShowHint()){
        rotateHint.removeAttribute('hidden');
      } else {
        rotateHint.setAttribute('hidden', '');
      }
    }
    updateDimensions();
  };

  const handleResize = ()=>{ applyOrientation(); };

  if (dismissBtn && rotateHint){
    dismissBtn.addEventListener('click', event=>{
      event.preventDefault();
      const storage = getStorage();
      if (storage){
        storage.setItem(storageKey, '1');
      }
      rotateHint.setAttribute('hidden', '');
      updateDimensions();
    });
  }

  applyOrientation();

  if (body && typeof MutationObserver === 'function'){
    const observer = new MutationObserver(applyOrientation);
    observer.observe(body, {attributes:true, attributeFilter:['class']});
  }

  if (typeof ORIENTATION_QUERY.addEventListener === 'function'){
    ORIENTATION_QUERY.addEventListener('change', applyOrientation);
  } else if (typeof ORIENTATION_QUERY.addListener === 'function'){
    ORIENTATION_QUERY.addListener(applyOrientation);
  }
  window.addEventListener('resize', handleResize);
  window.addEventListener('orientationchange', applyOrientation);
})();
</script>

<script>
(()=> {
  const DEFAULT_CLUSTERS = [
    "GP: Stafilococchi (MSSA/MRSA)",
    "GP: Streptococchi (Œ≤-emolitici, viridans, pneumoniae)",
    "GP: Enterococchi",
    "GP: Altri bacilli (Listeria, Coryne, Nocardia/Actino, Clostridioides, Bacillus)",
    "GN: Cocchi/Coccobacilli (Neisseria, H. influenzae, Moraxella)",
    "GN: Enterobacterales (lattosio+)",
    "GN: Enterobacterales (lattosio‚àí)",
    "GN: Non fermentanti (Pseudomonas)",
    "GN: Non fermentanti (Acinetobacter/Stenotrophomonas)",
    "Curvi/Atipici (Legionella/Chlamydia/Mycoplasma; Vibrio/Campy/Helicobacter)",
    "Anaerobi ‚Äî Sopra diaframma",
    "Anaerobi ‚Äî Sotto diaframma"
  ];

  /* ===== Gruppi antibiotici fissi ===== */
  const AB_GROUPS_ORDER = [
    "Œ≤-lattamici","Glicopeptidi","Lipopeptidi","Oxazolidinoni",
    "Macrolidi/Lincosamidi","Tetracicline","Fluorochinoloni","Sulfonamidi",
    "Aminoglicosidi","Polimixine","Nitro-","Altri"
  ];
  const CLINICAL_STRUCTURE_ERROR = 'File non valido: servono i campi ‚Äòselectables‚Äô e ‚Äòcases‚Äô.';
  function bucketAntibiotic(cat=""){
    const c=cat.toLowerCase();
    if (c.includes("lattam")) return "Œ≤-lattamici";
    if (c.includes("glicopept")) return "Glicopeptidi";
    if (c.includes("lipopept")||c.includes("lipept")) return "Lipopeptidi";
    if (c.includes("oxazolidin")) return "Oxazolidinoni";
    if (c.includes("macrol")||c.includes("lincos")) return "Macrolidi/Lincosamidi";
    if (c.includes("tetracicl")) return "Tetracicline";
    if (c.includes("fluorochinol")) return "Fluorochinoloni";
    if (c.includes("sulfonam")) return "Sulfonamidi";
    if (c.includes("aminoglicos")) return "Aminoglicosidi";
    if (c.includes("polimix")||c.includes("polymyx")) return "Polimixine";
    if (c.startsWith("nitro")||c.includes("nitroimid")||c.includes("nitrofur")) return "Nitro-";
    return "Altri";
  }

  /* ===== Stato ===== */
  let MODE = 'covers';
  let DRUGS = [];
  const DRUGS_BY_NAME = new Map();
  const DRUG_NAME_INDEX = new Map();
  let CASES = [];
  let currentCaseIdx = 0;
  let CLINICAL_SELECTABLES = [];
  const CLINICAL_SELECTABLES_BY_ID = new Map();
  let CLINICAL_GROUP_ORDER = [];
  const CLINICAL_SUBGROUP_ORDER = new Map();
  const clinicalSelections = new Set();
  let clinicalAutoFetchAttempted = false;
  let clinicalDataLoaded = false;
  let clinicalLoadedFileName = './data/clinical.json';
  // contatori per "Copre"
  const countersInit = new Map();   // drug -> {top:Set, bene:Set, ok:Set}
  const countersHit  = new Map();   // drug -> {top:Set, bene:Set, ok:Set}

  const lockedDrugs  = new Set();
  const warnedMissingClusters = new Map();

  const therapyState = {
    caseKey: null,
    definition: null,
    selections: new Map(),
    locked: false
  };

  const clinicalMatchProgress = {
    key: null,
    mode: 'set',
    allowExtras: false,
    slots: [],
    filledIds: new Set(),
    solved: false,
    notes: [],
    container: null,
    listEl: null,
    bannerEl: null,
    notesEl: null
  };
  let toastTimer = null;
  const bugDrugSearchMatches = new Set();
  let bugDrugSearchQuery = '';
  const DISCLAIMER_STORAGE_KEY = '__appDisclaimerOverride__';
  const DEFAULT_DISCLAIMER_TEXT = "Uso didattico e non commerciale. Non fornisce diagnosi/terapie; verificare sempre su fonti ufficiali. ¬© 2025 David Vigilanti ‚Äî MedGramo.";
  let disclaimerOverride = '';

  /* ===== DOM ===== */
  const rootContainer = document.body;
  const modeSelect = document.getElementById('modeSelect');
  const toolbar = document.querySelector('.toolbar');
  const toolbarPill = document.getElementById('toolbarPill');
  const toolbarCompactToggle = document.getElementById('toolbarCompactToggle');
  const toolbarCompactToggleIcon = toolbarCompactToggle ? toolbarCompactToggle.querySelector('.toolbar-icon') : null;
  const toolbarCompactToggleText = toolbarCompactToggle ? toolbarCompactToggle.querySelector('.toolbar-text') : null;
  const mainScroll = document.getElementById('mainScroll');
  const board = document.getElementById('board');
  const leftTitle  = document.getElementById('leftTitle');
  const rightTitle = document.getElementById('rightTitle');
  const leftList   = document.getElementById('leftList');
  const rightList  = document.getElementById('rightList');
  const disclaimerEl = document.getElementById('appDisclaimer');

  const isIOSDevice = ()=>{
    const ua = window.navigator?.userAgent || '';
    const platform = window.navigator?.platform || '';
    const maxTouchPoints = Number(window.navigator?.maxTouchPoints) || 0;
    return /(iPad|iPhone|iPod|FxiOS|CriOS)/i.test(ua) || (platform === 'MacIntel' && maxTouchPoints > 1);
  };

  document.title = 'Contagious ‚Äî MedGramo';

  const searchInput = document.getElementById('searchInput');
  const filterCategory = document.getElementById('filterCategory');
  const filterCluster  = document.getElementById('filterCluster');

  const warnBox   = document.getElementById('warnBox');
  const errorBox  = document.getElementById('errorBox');

  const fileDrugs = document.getElementById('fileDrugs');
  const fileCases = document.getElementById('fileCases');
  const clinicalLoader = document.getElementById('clinicalLoader');
  const clinicalStatus = document.getElementById('clinicalStatus');
  const btnLoadClinical = document.getElementById('btnLoadClinical');

  const locationProtocol = (typeof window !== 'undefined' && window.location && window.location.protocol)
    ? window.location.protocol
    : '';
  const locationSearch = (typeof window !== 'undefined' && window.location)
    ? window.location.search || ''
    : '';
  const locationParams = new URLSearchParams(locationSearch);
  const CLINICAL_UPLOAD_ALLOWED = (locationProtocol !== 'http:' && locationProtocol !== 'https:')
    || locationParams.get('dev') === '1';
  if (clinicalLoader && !CLINICAL_UPLOAD_ALLOWED){
    clinicalLoader.hidden = true;
  }

  const btnReshuffleTop = document.getElementById('btnReshuffleTop');
  const btnReset = document.getElementById('btnReset');
  const btnPrintPDF = document.getElementById('btnPrintPDF');
  const btnLearnInfo = document.getElementById('btnLearnInfo');
  const learnInfoPopover = document.getElementById('learnInfoPopover');
  const btnLearnInfoClose = document.getElementById('btnLearnInfoClose');
  const comingSoonButton = document.getElementById('comingSoonButton');
  const comingSoonLayer = document.getElementById('comingSoonLayer');
  const comingSoonPopover = document.getElementById('comingSoonPopover');
  const comingSoonClose = document.getElementById('comingSoonClose');

  const modal = document.getElementById('modal');
  const backdrop = document.getElementById('backdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const toast = document.getElementById('toast');

  /* ===== Toolbar compatta landscape iPhone ===== */
  const compactToolbarQueries = (typeof window !== 'undefined' && typeof window.matchMedia === 'function')
    ? [
        window.matchMedia('(max-width: 740px) and (orientation: landscape)'),
        window.matchMedia('(max-height: 460px) and (orientation: landscape)')
      ]
    : [];
  let compactToolbarActive = false;
  let toolbarMeasuredHeight = 0;
  let hideAfterScrollRaf = null;
  let recentShowGuardUntil = 0;
  let pullStartY = null;
  let pullStartScrollTop = 0;
  let pullActiveEl = null;
  let scrollContainerLastTop = 0;
  let scrollContainerListenersAttached = false;
  let columnLastScroll = new WeakMap();
  const columnEventMap = new Map();
  let toolbarResizeObserver = null;
  let metricsRaf = null;
  const TOOLBAR_VISUAL_COMPACT_KEY = '__toolbarCompactCollapsed__';
  const getSessionStorageSafe = ()=>{
    try {
      return window.sessionStorage || null;
    } catch (err){
      return null;
    }
  };
  let toolbarCollapsed = false;

  const persistToolbarCollapsedPreference = collapsed=>{
    const storage = getSessionStorageSafe();
    if (!storage) return;
    try {
      storage.setItem(TOOLBAR_VISUAL_COMPACT_KEY, collapsed ? '1' : '0');
    } catch (err){
      // storage non disponibile
    }
  };

  const readToolbarCollapsedPreference = ()=>{
    const storage = getSessionStorageSafe();
    if (!storage) return false;
    try {
      return storage.getItem(TOOLBAR_VISUAL_COMPACT_KEY) === '1';
    } catch (err){
      return false;
    }
  };

  const applyToolbarCollapsedPresentation = collapsed=>{
    toolbarCollapsed = !!collapsed;
    if (toolbar){
      toolbar.classList.toggle('toolbar--compact', toolbarCollapsed);
    }
    if (toolbarCompactToggle){
      const label = toolbarCollapsed ? 'Espandi toolbar' : 'Riduci toolbar';
      toolbarCompactToggle.setAttribute('aria-pressed', toolbarCollapsed ? 'true' : 'false');
      toolbarCompactToggle.setAttribute('aria-label', label);
      toolbarCompactToggle.setAttribute('title', label);
    }
    if (toolbarCompactToggleIcon){
      toolbarCompactToggleIcon.textContent = toolbarCollapsed ? '‚ñ¥' : '‚§¢';
    }
    if (toolbarCompactToggleText){
      toolbarCompactToggleText.textContent = toolbarCollapsed ? 'Espandi barra' : 'Riduci barra';
    }
  };

  const setToolbarCollapsed = (collapsed, {persist=true, skipMetrics=false}={})=>{
    applyToolbarCollapsedPresentation(collapsed);
    if (!skipMetrics && compactToolbarActive){
      updateToolbarMetrics();
    }
    if (persist){
      persistToolbarCollapsedPreference(toolbarCollapsed);
    }
  };

  const isCompactToolbarMode = ()=>compactToolbarQueries.some(q=>q && q.matches);

  const computeToolbarHeight = ()=>{
    if (!toolbar) return 0;
    const measured = Math.round(toolbar.scrollHeight);
    return measured > 0 ? measured : 0;
  };

  const applyToolbarMetrics = (height)=>{
    if (!toolbar || !height) return;
    toolbarMeasuredHeight = height;
    document.body.style.setProperty('--toolbar-h-compact', `${height}px`);
    if (!document.body.classList.contains('toolbar-hidden')){
      toolbar.style.height = `${height}px`;
    }
  };

  const updateToolbarMetrics = ()=>{
    if (!compactToolbarActive || !toolbar) return;
    if (metricsRaf){
      cancelAnimationFrame(metricsRaf);
    }
    metricsRaf = requestAnimationFrame(()=>{
      metricsRaf = null;
      const measured = computeToolbarHeight();
      if (measured && measured !== toolbarMeasuredHeight){
        applyToolbarMetrics(measured);
      }
    });
  };

  const showToolbar = ()=>{
    if (!compactToolbarActive || !toolbar) return;
    if (hideAfterScrollRaf){
      cancelAnimationFrame(hideAfterScrollRaf);
      hideAfterScrollRaf = null;
    }
    if (!document.body.classList.contains('toolbar-hidden')){
      updateToolbarMetrics();
      return;
    }
    const measured = computeToolbarHeight() || toolbarMeasuredHeight;
    if (measured){
      toolbar.style.height = `${measured}px`;
      applyToolbarMetrics(measured);
    }
    document.body.classList.remove('toolbar-hidden');
    if (toolbarPill){
      toolbarPill.hidden = true;
      toolbarPill.setAttribute('aria-hidden','true');
    }
    recentShowGuardUntil = Date.now() + 600;
  };

  const hideToolbar = ()=>{
    if (!compactToolbarActive || !toolbar) return;
    if (document.body.classList.contains('toolbar-hidden')) return;
    const measured = computeToolbarHeight();
    if (measured && measured !== toolbarMeasuredHeight){
      document.body.style.setProperty('--toolbar-h-compact', `${measured}px`);
      toolbarMeasuredHeight = measured;
    }
    toolbar.style.height = '0px';
    document.body.classList.add('toolbar-hidden');
    if (toolbarPill){
      toolbarPill.hidden = false;
      toolbarPill.setAttribute('aria-hidden','false');
    }
  };

  const onScrollContainer = ()=>{
    if (!compactToolbarActive || !mainScroll) return;
    const previous = scrollContainerLastTop;
    const current = mainScroll.scrollTop;
    scrollContainerLastTop = current;
    if (document.body.classList.contains('toolbar-hidden')) return;
    if (Date.now() < recentShowGuardUntil) return;
    if (current <= previous) return;
    if (current < 28) return;
    if (hideAfterScrollRaf){
      cancelAnimationFrame(hideAfterScrollRaf);
    }
    hideAfterScrollRaf = requestAnimationFrame(()=>{
      hideAfterScrollRaf = null;
      hideToolbar();
    });
  };

  const onColumnScroll = col=>{
    if (!compactToolbarActive || !col) return;
    const previous = columnLastScroll.get(col) ?? col.scrollTop;
    const current = col.scrollTop;
    columnLastScroll.set(col, current);
    if (document.body.classList.contains('toolbar-hidden')) return;
    if (Date.now() < recentShowGuardUntil) return;
    if (current <= previous) return;
    if (current < 28) return;
    if (hideAfterScrollRaf){
      cancelAnimationFrame(hideAfterScrollRaf);
    }
    hideAfterScrollRaf = requestAnimationFrame(()=>{
      hideAfterScrollRaf = null;
      hideToolbar();
    });
  };

  const resetPullState = ()=>{
    pullStartY = null;
    pullStartScrollTop = 0;
    pullActiveEl = null;
  };

  const onTouchStartContainer = event=>{
    if (!compactToolbarActive || !mainScroll) return;
    if (!event.touches || event.touches.length !== 1) return;
    pullActiveEl = mainScroll;
    pullStartY = event.touches[0].clientY;
    pullStartScrollTop = mainScroll.scrollTop;
  };

  const onTouchMoveContainer = event=>{
    if (!compactToolbarActive || !mainScroll) return;
    if (!pullActiveEl || pullActiveEl !== mainScroll) return;
    if (!event.touches || event.touches.length !== 1) return;
    if (!document.body.classList.contains('toolbar-hidden')) return;
    if (pullStartScrollTop > 2) return;
    const delta = event.touches[0].clientY - pullStartY;
    if (delta >= 20 && mainScroll.scrollTop <= 0){
      showToolbar();
      resetPullState();
    }
  };

  const onTouchStartColumn = (event, col)=>{
    if (!compactToolbarActive || !col) return;
    if (!event.touches || event.touches.length !== 1) return;
    pullActiveEl = col;
    pullStartY = event.touches[0].clientY;
    pullStartScrollTop = col.scrollTop;
  };

  const onTouchMoveColumn = (event, col)=>{
    if (!compactToolbarActive || !col) return;
    if (!pullActiveEl || pullActiveEl !== col) return;
    if (!event.touches || event.touches.length !== 1) return;
    if (!document.body.classList.contains('toolbar-hidden')) return;
    if (pullStartScrollTop > 2) return;
    const delta = event.touches[0].clientY - pullStartY;
    if (delta >= 20 && col.scrollTop <= 0 && (!mainScroll || mainScroll.scrollTop <= 0)){
      showToolbar();
      resetPullState();
    }
  };

  const onTouchEnd = ()=>{
    resetPullState();
  };

  const detachScrollContainerListeners = ()=>{
    if (!mainScroll || !scrollContainerListenersAttached) return;
    mainScroll.removeEventListener('scroll', onScrollContainer);
    mainScroll.removeEventListener('touchstart', onTouchStartContainer);
    mainScroll.removeEventListener('touchmove', onTouchMoveContainer);
    mainScroll.removeEventListener('touchend', onTouchEnd);
    mainScroll.removeEventListener('touchcancel', onTouchEnd);
    scrollContainerListenersAttached = false;
    scrollContainerLastTop = 0;
    resetPullState();
  };

  const attachScrollContainerListeners = ()=>{
    if (!mainScroll || scrollContainerListenersAttached) return;
    mainScroll.addEventListener('scroll', onScrollContainer, {passive:true});
    mainScroll.addEventListener('touchstart', onTouchStartContainer, {passive:true});
    mainScroll.addEventListener('touchmove', onTouchMoveContainer, {passive:true});
    mainScroll.addEventListener('touchend', onTouchEnd, {passive:true});
    mainScroll.addEventListener('touchcancel', onTouchEnd, {passive:true});
    scrollContainerLastTop = mainScroll.scrollTop || 0;
    scrollContainerListenersAttached = true;
  };

  const detachColumnListeners = ()=>{
    columnEventMap.forEach((handlers, col)=>{
      if (!col) return;
      if (handlers.scroll) col.removeEventListener('scroll', handlers.scroll);
      if (handlers.touchstart) col.removeEventListener('touchstart', handlers.touchstart);
      if (handlers.touchmove) col.removeEventListener('touchmove', handlers.touchmove);
      if (handlers.touchend){
        col.removeEventListener('touchend', handlers.touchend);
        col.removeEventListener('touchcancel', handlers.touchend);
      }
    });
    columnEventMap.clear();
    columnLastScroll = new WeakMap();
  };

  const attachColumnListeners = ()=>{
    detachColumnListeners();
    const columns = document.querySelectorAll('#board .col');
    columns.forEach(col=>{
      const handlers = {
        scroll: ()=>onColumnScroll(col),
        touchstart: event=>onTouchStartColumn(event, col),
        touchmove: event=>onTouchMoveColumn(event, col),
        touchend: ()=>onTouchEnd()
      };
      columnEventMap.set(col, handlers);
      col.addEventListener('scroll', handlers.scroll, {passive:true});
      col.addEventListener('touchstart', handlers.touchstart, {passive:true});
      col.addEventListener('touchmove', handlers.touchmove, {passive:true});
      col.addEventListener('touchend', handlers.touchend, {passive:true});
      col.addEventListener('touchcancel', handlers.touchend, {passive:true});
      columnLastScroll.set(col, col.scrollTop || 0);
    });
  };

  const enableCompactToolbar = ()=>{
    if (compactToolbarActive || !toolbar) return;
    compactToolbarActive = true;
    document.body.classList.add('toolbar-compact-active');
    document.body.classList.remove('toolbar-hidden');
    if (toolbarPill){
      toolbarPill.hidden = true;
      toolbarPill.setAttribute('aria-hidden','true');
    }
    const storedCollapsed = readToolbarCollapsedPreference();
    setToolbarCollapsed(storedCollapsed, {persist:false, skipMetrics:true});
    const initialHeight = computeToolbarHeight();
    if (initialHeight){
      toolbar.style.height = `${initialHeight}px`;
      applyToolbarMetrics(initialHeight);
    } else {
      toolbar.style.removeProperty('height');
    }
    updateToolbarMetrics();
    attachScrollContainerListeners();
    attachColumnListeners();
    if (typeof ResizeObserver === 'function' && toolbar){
      toolbarResizeObserver = new ResizeObserver(()=>{ updateToolbarMetrics(); });
      toolbarResizeObserver.observe(toolbar);
    }
    recentShowGuardUntil = Date.now() + 600;
  };

  const disableCompactToolbar = ()=>{
    if (!compactToolbarActive) return;
    compactToolbarActive = false;
    document.body.classList.remove('toolbar-compact-active');
    document.body.classList.remove('toolbar-hidden');
    setToolbarCollapsed(false, {persist:false, skipMetrics:true});
    if (toolbarPill){
      toolbarPill.hidden = true;
      toolbarPill.setAttribute('aria-hidden','true');
    }
    if (toolbar){
      toolbar.style.removeProperty('height');
    }
    document.body.style.removeProperty('--toolbar-h-compact');
    detachScrollContainerListeners();
    detachColumnListeners();
    if (toolbarResizeObserver){
      toolbarResizeObserver.disconnect();
      toolbarResizeObserver = null;
    }
    if (hideAfterScrollRaf){
      cancelAnimationFrame(hideAfterScrollRaf);
      hideAfterScrollRaf = null;
    }
    if (metricsRaf){
      cancelAnimationFrame(metricsRaf);
      metricsRaf = null;
    }
    toolbarMeasuredHeight = 0;
    resetPullState();
  };

  const evaluateCompactToolbar = ()=>{
    if (!compactToolbarQueries.length || !toolbar) return;
    if (isCompactToolbarMode()){
      enableCompactToolbar();
      updateToolbarMetrics();
    } else {
      disableCompactToolbar();
    }
  };

  if (toolbarPill){
    toolbarPill.addEventListener('click', ()=>{
      showToolbar();
    });
  }

  if (toolbarCompactToggle){
    toolbarCompactToggle.addEventListener('click', ()=>{
      if (!compactToolbarActive){
        const next = !toolbarCollapsed;
        toolbarCollapsed = next;
        persistToolbarCollapsedPreference(next);
        return;
      }
      setToolbarCollapsed(!toolbarCollapsed);
    });
  }

  if (compactToolbarQueries.length){
    compactToolbarQueries.forEach(mq=>{
      if (!mq) return;
      const listener = ()=>evaluateCompactToolbar();
      if (typeof mq.addEventListener === 'function'){
        mq.addEventListener('change', listener);
      } else if (typeof mq.addListener === 'function'){
        mq.addListener(listener);
      }
    });
    if (typeof window !== 'undefined'){
      window.addEventListener('resize', ()=>{
        if (compactToolbarActive){
          updateToolbarMetrics();
        }
      });
    }
    evaluateCompactToolbar();
  }

  /* ===== Disclaimer ===== */
  const readStoredDisclaimer = ()=>{
    if (typeof window.__APP_DISCLAIMER__ === 'string'){
      const trimmed = window.__APP_DISCLAIMER__.trim();
      if (trimmed) return trimmed;
    }
    try {
      const stored = localStorage.getItem(DISCLAIMER_STORAGE_KEY);
      if (typeof stored === 'string' && stored.trim()){
        return stored.trim();
      }
    } catch (err) {
      // storage non disponibile
    }
    return '';
  };

  const applyDisclaimerText = ()=>{
    if (!disclaimerEl) return;
    const text = disclaimerOverride || DEFAULT_DISCLAIMER_TEXT;
    disclaimerEl.innerHTML = '';
    const textSpan = document.createElement('span');
    textSpan.textContent = text;
    const link = document.createElement('a');
    link.className = 'disclaimer-license';
    link.href = 'LICENSE';
    link.textContent = 'Leggi la LICENSE';
    disclaimerEl.appendChild(textSpan);
    disclaimerEl.appendChild(document.createTextNode(' '));
    disclaimerEl.appendChild(link);
  };

  disclaimerOverride = readStoredDisclaimer();

  const persistDisclaimer = ()=>{
    try {
      if (disclaimerOverride){
        localStorage.setItem(DISCLAIMER_STORAGE_KEY, disclaimerOverride);
      } else {
        localStorage.removeItem(DISCLAIMER_STORAGE_KEY);
      }
    } catch (err) {
      // storage non disponibile
    }
  };

  persistDisclaimer();
  applyDisclaimerText();

  if (typeof window !== 'undefined'){
    try {
      Object.defineProperty(window, '__APP_DISCLAIMER__', {
        configurable: true,
        get(){
          return disclaimerOverride || DEFAULT_DISCLAIMER_TEXT;
        },
        set(value){
          disclaimerOverride = (typeof value === 'string') ? value.trim() : '';
          persistDisclaimer();
          applyDisclaimerText();
        }
      });
    } catch (err) {
      window.__APP_DISCLAIMER__ = disclaimerOverride;
    }
  }

  /* ===== Coming soon popover ===== */
  const COMING_SOON_FOCUS_SELECTOR = 'a[href], area[href], button:not([disabled]), input:not([disabled]):not([type="hidden"]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
  const comingSoonMobileQuery = (typeof window !== 'undefined' && typeof window.matchMedia === 'function')
    ? window.matchMedia('(max-width: 720px)')
    : null;
  let comingSoonLastFocused = null;
  let comingSoonFocusables = [];

  const isComingSoonOpen = ()=>comingSoonLayer && comingSoonLayer.getAttribute('aria-hidden') === 'false';

  const refreshComingSoonFocusables = ()=>{
    if (!comingSoonPopover) return;
    comingSoonFocusables = Array.from(comingSoonPopover.querySelectorAll(COMING_SOON_FOCUS_SELECTOR))
      .filter(el=>!el.hasAttribute('disabled') && el.getAttribute('aria-hidden') !== 'true');
  };

  const applyComingSoonPosition = ()=>{
    if (!comingSoonButton || !comingSoonLayer || !comingSoonPopover) return;
    const isMobile = comingSoonMobileQuery ? comingSoonMobileQuery.matches : window.innerWidth <= 720;
    comingSoonLayer.classList.toggle('is-mobile', !!isMobile);
    if (isMobile){
      comingSoonPopover.style.position = 'relative';
      comingSoonPopover.style.removeProperty('top');
      comingSoonPopover.style.removeProperty('left');
      comingSoonPopover.style.removeProperty('transform');
      return;
    }
    const margin = 12;
    comingSoonPopover.style.position = 'absolute';
    const rect = comingSoonButton.getBoundingClientRect();
    const popRect = comingSoonPopover.getBoundingClientRect();
    const viewportWidth = document.documentElement?.clientWidth || window.innerWidth || 0;
    const viewportHeight = window.innerHeight || 0;
    let top = rect.bottom + window.scrollY + margin;
    let left = rect.right + window.scrollX - popRect.width;
    if ((left + popRect.width) > (viewportWidth - margin)){
      left = viewportWidth - popRect.width - margin;
    }
    if (left < margin){
      left = margin;
    }
    if ((top + popRect.height) > (window.scrollY + viewportHeight - margin)){
      top = rect.top + window.scrollY - popRect.height - margin;
      if (top < window.scrollY + margin){
        top = window.scrollY + margin;
      }
    }
    comingSoonPopover.style.top = `${top}px`;
    comingSoonPopover.style.left = `${left}px`;
  };

  const onComingSoonLayoutChange = ()=>{
    if (!isComingSoonOpen()) return;
    applyComingSoonPosition();
  };

  const closeComingSoon = ()=>{
    if (!isComingSoonOpen()) return;
    comingSoonLayer.setAttribute('aria-hidden', 'true');
    comingSoonLayer.hidden = true;
    comingSoonLayer.classList.remove('is-mobile');
    if (comingSoonPopover){
      comingSoonPopover.style.removeProperty('position');
      comingSoonPopover.style.removeProperty('top');
      comingSoonPopover.style.removeProperty('left');
      comingSoonPopover.style.removeProperty('transform');
    }
    if (comingSoonButton){
      comingSoonButton.setAttribute('aria-expanded', 'false');
    }
    document.removeEventListener('keydown', onComingSoonKeydown);
    window.removeEventListener('resize', onComingSoonLayoutChange);
    window.removeEventListener('scroll', onComingSoonLayoutChange, true);
    const toFocus = comingSoonLastFocused && typeof comingSoonLastFocused.focus === 'function'
      ? comingSoonLastFocused
      : comingSoonButton;
    comingSoonLastFocused = null;
    comingSoonFocusables = [];
    if (toFocus && typeof toFocus.focus === 'function'){
      toFocus.focus();
    }
  };

  const onComingSoonKeydown = event=>{
    if (!isComingSoonOpen()) return;
    if (event.key === 'Escape' || event.key === 'Esc'){
      event.preventDefault();
      closeComingSoon();
      return;
    }
    if (event.key !== 'Tab') return;
    refreshComingSoonFocusables();
    if (!comingSoonFocusables.length){
      event.preventDefault();
      if (comingSoonPopover && typeof comingSoonPopover.focus === 'function'){
        comingSoonPopover.focus();
      }
      return;
    }
    const first = comingSoonFocusables[0];
    const last = comingSoonFocusables[comingSoonFocusables.length - 1];
    const active = document.activeElement;
    if (event.shiftKey){
      if (active === first || !comingSoonPopover?.contains(active)){
        event.preventDefault();
        last.focus();
      }
    } else {
      if (active === last){
        event.preventDefault();
        first.focus();
      }
    }
  };

  const openComingSoon = ()=>{
    if (!comingSoonButton || !comingSoonLayer || !comingSoonPopover) return;
    if (isComingSoonOpen()) return;
    comingSoonLastFocused = document.activeElement instanceof HTMLElement ? document.activeElement : null;
    comingSoonLayer.hidden = false;
    comingSoonLayer.setAttribute('aria-hidden', 'false');
    comingSoonButton.setAttribute('aria-expanded', 'true');
    refreshComingSoonFocusables();
    requestAnimationFrame(()=>{
      applyComingSoonPosition();
      requestAnimationFrame(()=>{
        applyComingSoonPosition();
        const focusTarget = comingSoonFocusables.length ? comingSoonFocusables[0] : comingSoonPopover;
        if (focusTarget && typeof focusTarget.focus === 'function'){
          focusTarget.focus();
        }
      });
    });
    document.addEventListener('keydown', onComingSoonKeydown);
    window.addEventListener('resize', onComingSoonLayoutChange);
    window.addEventListener('scroll', onComingSoonLayoutChange, true);
  };

  if (comingSoonLayer){
    comingSoonLayer.addEventListener('pointerdown', event=>{
      if (!isComingSoonOpen()) return;
      if (!comingSoonPopover || comingSoonPopover.contains(event.target)) return;
      closeComingSoon();
    });
  }

  if (comingSoonClose){
    comingSoonClose.addEventListener('click', ()=>{
      closeComingSoon();
    });
  }

  if (comingSoonButton){
    comingSoonButton.addEventListener('click', event=>{
      event.preventDefault();
      if (isComingSoonOpen()){
        closeComingSoon();
      } else {
        openComingSoon();
      }
    });
  }

  if (comingSoonMobileQuery){
    const comingSoonMediaListener = ()=>{
      if (isComingSoonOpen()){
        applyComingSoonPosition();
      }
    };
    if (typeof comingSoonMobileQuery.addEventListener === 'function'){
      comingSoonMobileQuery.addEventListener('change', comingSoonMediaListener);
    } else if (typeof comingSoonMobileQuery.addListener === 'function'){
      comingSoonMobileQuery.addListener(comingSoonMediaListener);
    }
  }

  /* ===== Utils ===== */
  const esc = s => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const shuffle = a => a.map(v=>({v,r:Math.random()})).sort((x,y)=>x.r-y.r).map(x=>x.v);
  const normalizeSearchValue = value =>
    typeof value === 'string'
      ? value
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/\s+/g, ' ')
          .trim()
      : '';

  const getDrugSearchHaystack = drug => {
    if (!drug || typeof drug !== 'object') return '';
    if (typeof drug._searchHaystack === 'string') return drug._searchHaystack;
    const parts = [];
    const push = value => {
      if (typeof value === 'string'){
        const trimmed = value.trim();
        if (trimmed) parts.push(trimmed);
      }
    };
    push(drug.drug);
    push(drug.category);
    if (typeof drug.name === 'string') push(drug.name);
    if (typeof drug.label === 'string') push(drug.label);
    if (Array.isArray(drug.aliases)) drug.aliases.forEach(push);
    if (Array.isArray(drug.synonyms)) drug.synonyms.forEach(push);
    if (Array.isArray(drug.members)) drug.members.forEach(push);
    if (Array.isArray(drug.matches)){
      drug.matches.forEach(match=>{
        if (match && typeof match === 'object'){
          push(match.cluster);
        }
      });
    }
    if (Array.isArray(drug.avoid)) drug.avoid.forEach(push);
    push(drug.notes);
    push(drug.source);
    if (typeof getDrugNormalizedNames === 'function'){
      getDrugNormalizedNames(drug).forEach(name=>{
        if (name) parts.push(name);
      });
    }
    const haystack = normalizeSearchValue(parts.join(' '));
    drug._searchHaystack = haystack;
    return haystack;
  };

  const clearWarn = ()=>{ warnBox.style.display='none'; warnBox.textContent=''; };
  const showWarn = msg=>{ warnBox.innerHTML=msg; warnBox.style.display='block'; };
  const clearError = ()=>{ errorBox.style.display='none'; errorBox.textContent=''; };
  const setLearnInfoVisible = (show)=>{
    if (!learnInfoPopover) return;
    if (show){
      learnInfoPopover.classList.add('show');
      learnInfoPopover.setAttribute('aria-hidden','false');
      if (btnLearnInfo) btnLearnInfo.setAttribute('aria-expanded','true');
      setTimeout(()=>{ if (btnLearnInfoClose) btnLearnInfoClose.focus(); }, 0);
    } else {
      learnInfoPopover.classList.remove('show');
      learnInfoPopover.setAttribute('aria-hidden','true');
      if (btnLearnInfo) btnLearnInfo.setAttribute('aria-expanded','false');
    }
  };
  const showError  = msg=>{ errorBox.textContent=msg; errorBox.style.display='block'; };
  const showToast = (msg,kind='mid',duration=1600)=>{
    if (!toast) return;
    toast.textContent = msg;
    toast.className = 'toast show '+(kind==='ok'?'ok':kind==='bad'?'bad':'mid');
    if (toastTimer){
      clearTimeout(toastTimer);
    }
    const ms = Math.max(600, Number(duration)||0);
    toastTimer = setTimeout(()=>{
      toast.className='toast';
      toastTimer = null;
    }, ms);
  };

  const updateClinicalLoaderStatus = (fileName)=>{
    if (typeof fileName === 'string' && fileName.trim()){
      clinicalLoadedFileName = fileName.trim();
    }
    if (!clinicalStatus) return;
    if (clinicalDataLoaded){
      const name = clinicalLoadedFileName || './data/clinical.json';
      clinicalStatus.textContent = `Caricato: ${name} ‚Äî Casi: ${CASES.length} ‚Äî Selezionabili: ${CLINICAL_SELECTABLES.length}`;
      clinicalStatus.style.display = '';
    } else {
      clinicalStatus.textContent = '';
      clinicalStatus.style.display = 'none';
    }
  };

  const priorityBucket = p => (p>=3 ? 'top' : p===2 ? 'bene' : 'ok');

  const clusterClass = name => name.startsWith('GP:') ? 'cluster-gp'
                              : name.startsWith('GN:') ? 'cluster-gn'
                              : 'cluster-ot';

  const bugDrugClusterTagClass = name => {
    if (!name) return '';
    const trimmed = String(name).trim();
    if (!trimmed) return '';
    if (/^GP:/i.test(trimmed)) return 'tag-gp';
    if (/^GN:/i.test(trimmed)) return 'tag-gn';
    const normalized = trimmed
      .replace(/[‚Äì‚Äî]/g, '-')
      .replace(/\s*-\s*/g, ' - ')
      .replace(/\s+/g, ' ')
      .toLowerCase();
    if (normalized.startsWith('curvi/atipici')) return 'tag-curvi';
    if (normalized.startsWith('anaerobi - sopra diaframma')) return 'tag-ana-up';
    if (normalized.startsWith('anaerobi - sotto diaframma')) return 'tag-ana-down';
    return '';
  };

  const formatMultiline = txt => esc(txt||'').replace(/\n/g,'<br>');

  const cleanString = value => typeof value === 'string' ? value.trim() : '';
  const pickFirstString = arr => {
    if (!Array.isArray(arr)) return '';
    for (const value of arr){
      if (typeof value === 'string'){
        const trimmed = value.trim();
        if (trimmed) return trimmed;
      }
    }
    return '';
  };
  const normalizeStringList = arr => Array.isArray(arr)
    ? arr.map(v=>cleanString(v)).filter(Boolean)
    : [];

  function normalizeClinicalSelectable(entry, idx){
    if (!entry || typeof entry !== 'object'){
      throw new Error(`selectables[${idx}] deve essere un oggetto.`);
    }
    const idRaw = entry.id ?? entry.key ?? entry.value;
    if (idRaw===undefined || idRaw===null){
      throw new Error(`selectables[${idx}] manca il campo "id".`);
    }
    const id = cleanString(String(idRaw));
    if (!id){
      throw new Error(`selectables[${idx}] ha un id vuoto.`);
    }
    const name = cleanString(entry.name) || cleanString(entry.label);
    if (!name){
      throw new Error(`selectables[${idx}] manca il campo "name".`);
    }
    const typeRaw = cleanString(entry.type).toLowerCase();
    const type = typeRaw || 'drug';
    const group = cleanString(entry.group) || 'Senza gruppo';
    const subgroup = cleanString(entry.subgroup);
    return {
      ...entry,
      id,
      name,
      type,
      group,
      subgroup: subgroup || null,
      __lowerName: name.toLowerCase()
    };
  }

  function normalizeClinicalMatchingEntry(entry){
    if (entry===null || entry===undefined) return null;
    if (typeof entry === 'string' || typeof entry === 'number'){
      const id = cleanString(String(entry));
      return id ? {id, type:null} : null;
    }
    if (typeof entry === 'object'){
      const idRaw = entry.id ?? entry.selectable_id ?? entry.value ?? entry.key ?? entry.ref ?? null;
      if (idRaw===undefined || idRaw===null){
        const fallback = cleanString(entry.name);
        return fallback ? {id:fallback, type: cleanString(entry.type)||null} : null;
      }
      const id = cleanString(String(idRaw));
      if (!id) return null;
      const type = cleanString(entry.type);
      return {id, type: type||null};
    }
    return null;
  }

  function normalizeClinicalMatching(raw){
    const source = (raw && typeof raw === 'object') ? raw : {};
    const mode = cleanString(source.mode).toLowerCase() || 'set';
    const essentials = Array.isArray(source.essentials)
      ? source.essentials.map(normalizeClinicalMatchingEntry).filter(Boolean)
      : [];
    const extras = Array.isArray(source.extras)
      ? source.extras.map(normalizeClinicalMatchingEntry).filter(Boolean)
      : [];
    const allowExtras = source.allow_extras === true;
    return {mode, essentials, extras, allowExtras};
  }

  function normalizeClinicalRecommended(entry){
    if (!entry || typeof entry !== 'object') return null;
    const regimen = normalizeStringList(entry.regimen);
    if (!regimen.length){
      const single = cleanString(entry.regimen);
      if (single) regimen.push(single);
    }
    const setting = cleanString(entry.setting);
    const rationale = cleanString(entry.rationale);
    const source = cleanString(entry.source);
    if (!regimen.length && !setting && !rationale && !source) return null;
    return {regimen, setting, rationale, source};
  }

  function normalizeClinicalCase(entry, idx){
    if (!entry || typeof entry !== 'object'){
      throw new Error(`cases[${idx}] deve essere un oggetto.`);
    }
    const title = cleanString(entry.title) || `Caso ${idx+1}`;
    const vignette = typeof entry.vignette === 'string' ? entry.vignette : '';
    const hints = normalizeStringList(entry.hints);
    if (!hints.length){
      const singleHint = cleanString(entry.hint);
      if (singleHint) hints.push(singleHint);
    }
    const diagnosis = cleanString(entry.diagnosis) || cleanString(entry.displayDiagnosis);
    const notes = normalizeStringList(entry.notes_on_completion);
    const recommended = Array.isArray(entry.recommended)
      ? entry.recommended.map(normalizeClinicalRecommended).filter(Boolean)
      : [];
    const matching = normalizeClinicalMatching(entry.matching);
    return {
      ...entry,
      __title: title,
      __vignette: vignette,
      __hints: hints,
      __diagnosis: diagnosis,
      __notesOnCompletion: notes,
      __recommended: recommended,
      __matching: matching
    };
  }

  function applyClinicalData(raw){
    if (!raw || typeof raw !== 'object'){
      throw new Error(CLINICAL_STRUCTURE_ERROR);
    }
    if (!Array.isArray(raw.selectables) || !Array.isArray(raw.cases)){
      throw new Error(CLINICAL_STRUCTURE_ERROR);
    }
    const selectables = raw.selectables.map((entry, idx)=>normalizeClinicalSelectable(entry, idx));
    CLINICAL_SELECTABLES = selectables;
    CLINICAL_SELECTABLES_BY_ID.clear();
    selectables.forEach(sel=>{ CLINICAL_SELECTABLES_BY_ID.set(sel.id, sel); });
    const baseGroupOrder = Array.isArray(raw.group_order)
      ? raw.group_order.map(group=>cleanString(group)).filter(Boolean)
      : [];
    const dedupGroupOrder = [];
    const seenBaseGroups = new Set();
    baseGroupOrder.forEach(group=>{
      if (seenBaseGroups.has(group)) return;
      seenBaseGroups.add(group);
      dedupGroupOrder.push(group);
    });
    CLINICAL_GROUP_ORDER = dedupGroupOrder;
    CLINICAL_SUBGROUP_ORDER.clear();
    if (raw && raw.subgroup_order && typeof raw.subgroup_order === 'object'){
      Object.entries(raw.subgroup_order).forEach(([groupName, list])=>{
        const cleanGroup = cleanString(groupName);
        if (!cleanGroup) return;
        const order = Array.isArray(list)
          ? list.map(name=>cleanString(name)).filter(Boolean)
          : [];
        if (!order.length) return;
        const uniqueOrder = [];
        const seen = new Set();
        order.forEach(name=>{
          if (seen.has(name)) return;
          seen.add(name);
          uniqueOrder.push(name);
        });
        if (uniqueOrder.length) CLINICAL_SUBGROUP_ORDER.set(cleanGroup, uniqueOrder);
      });
    }
    const foundGroups = [];
    const groupSeen = new Set();
    const subgroupByGroup = new Map();
    selectables.forEach(sel=>{
      const group = sel.group || 'Senza gruppo';
      if (!groupSeen.has(group)){
        groupSeen.add(group);
        foundGroups.push(group);
      }
      if (sel.subgroup){
        if (!subgroupByGroup.has(group)) subgroupByGroup.set(group, []);
        const arr = subgroupByGroup.get(group);
        if (!arr.includes(sel.subgroup)) arr.push(sel.subgroup);
      }
    });
    if (!CLINICAL_GROUP_ORDER.length){
      CLINICAL_GROUP_ORDER = foundGroups.slice();
    } else {
      const seenOrder = new Set(CLINICAL_GROUP_ORDER);
      foundGroups.forEach(group=>{
        if (!seenOrder.has(group)){
          CLINICAL_GROUP_ORDER.push(group);
          seenOrder.add(group);
        }
      });
    }
    subgroupByGroup.forEach((subgroups, group)=>{
      if (!subgroups.length) return;
      if (CLINICAL_SUBGROUP_ORDER.has(group)){
        const existing = CLINICAL_SUBGROUP_ORDER.get(group).slice();
        const seenSubs = new Set(existing);
        subgroups.forEach(name=>{
          if (!seenSubs.has(name)){
            existing.push(name);
            seenSubs.add(name);
          }
        });
        CLINICAL_SUBGROUP_ORDER.set(group, existing);
      }
    });
    CASES = raw.cases.map((entry, idx)=>normalizeClinicalCase(entry, idx));
    resetClinicalMatchingProgress();
    currentCaseIdx = 0;
    clinicalSelections.clear();
    clinicalAutoFetchAttempted = true;
    clinicalDataLoaded = true;
    const missing = new Set();
    CASES.forEach(cs=>{
      const essentials = cs?.__matching?.essentials || [];
      essentials.forEach(req=>{
        if (req && req.id && !CLINICAL_SELECTABLES_BY_ID.has(req.id)){
          missing.add(req.id);
        }
      });
    });
    clearWarn();
    if (missing.size){
      showWarn(`Elementi mancanti in selectables: ${Array.from(missing).map(name=>esc(name)).join(', ')}`);
    }
    updateClinicalLoaderStatus();
  }

  function applyMatchingDataset(matching){
    if (!Array.isArray(matching)){
      throw new Error('File farmaci: atteso un array.');
    }
    DRUGS = matching;
    buildCounters();
    prepareFilters();
    forceResetTherapyState();
  }

  function initBugDrug(matching){
    applyMatchingDataset(matching);
    renderByMode();
  }

  function initImpara(matching){
    if (Array.isArray(matching) && matching !== DRUGS){
      applyMatchingDataset(matching);
    }
    renderByMode();
  }

  function initClinica(clinical){
    applyClinicalData(clinical);
    updateClinicalLoaderStatus('./data/clinical.json');
    renderByMode();
  }

  if (typeof window !== 'undefined'){
    window.initBugDrug = initBugDrug;
    window.initImpara = initImpara;
    window.initClinica = initClinica;
  }

  function ensureClinicalAutoLoad(){
    if (clinicalAutoFetchAttempted || CLINICAL_SELECTABLES.length) return;
    clinicalAutoFetchAttempted = true;
    fetch('./data/clinical.json')
      .then(resp=>{ if (!resp.ok) throw new Error('Not found'); return resp.json(); })
      .then(json=>{
        try {
          applyClinicalData(json);
          showToast('./data/clinical.json caricato','ok');
          updateClinicalLoaderStatus('./data/clinical.json');
          renderByMode();
        } catch(err){
          console.error('Errore caricando ./data/clinical.json di default', err);
        }
      })
      .catch(()=>{
        // opzionale, nessun ./data/clinical.json predefinito
      });
  }

  const getCurrentClinicalCase = ()=> CASES[currentCaseIdx] || null;
  const filterClinicalSelectables = ()=>{
    const query = (searchInput.value||'').toLowerCase().trim();
    if (!query) return CLINICAL_SELECTABLES;
    return CLINICAL_SELECTABLES.filter(sel=> sel.__lowerName.includes(query));
  };

  function getCaseClusterInfo(cs){
    const essential = [];
    const optional = [];
    if (Array.isArray(cs?.essentialClusters)){
      cs.essentialClusters.forEach(entry=>{
        if (typeof entry === 'string') essential.push(entry);
        else if (entry && entry.name) essential.push(entry.name);
      });
    }
    if (Array.isArray(cs?.clusters)){
      cs.clusters.forEach(entry=>{
        if (typeof entry === 'string') essential.push(entry);
        else if (entry && entry.name){
          if (entry.essential===false) optional.push(entry.name);
          else essential.push(entry.name);
        }
      });
    }
    if (Array.isArray(cs?.clusters_suggested)){
      cs.clusters_suggested.forEach(entry=>{
        if (typeof entry === 'string') optional.push(entry);
        else if (entry && entry.name){
          if (entry.essential) essential.push(entry.name);
          else optional.push(entry.name);
        }
      });
    }
    const dedupe = list => list.filter((name, idx)=> name && list.indexOf(name)===idx);
    const essentialList = dedupe(essential);
    const optionalList = dedupe(optional.filter(name=>!essentialList.includes(name)));
    const allOrdered = [...essentialList, ...optionalList];
    const essentialSet = new Set(essentialList);
    const optionalSet = new Set(optionalList);
    const contraSet = new Set(Array.isArray(cs?.contra)?cs.contra.filter(Boolean):[]);
    return {essential:essentialList, optional:optionalList, allOrdered, essentialSet, optionalSet, contraSet};
  }

  const normalizeTherapyName = name =>
    typeof name === 'string'
      ? name
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/\s+/g, ' ')
          .trim()
      : '';

  function makeTherapySlot(entry){
    const accepts = new Set();
    let display = '';
    let placeholder = '';
    const addCandidate = str => {
      if (typeof str !== 'string') return;
      const trimmed = str.trim();
      if (!trimmed) return;
      const normalized = normalizeTherapyName(trimmed);
      if (normalized) accepts.add(normalized);
      const noParen = trimmed.replace(/\s*\(.*?\)\s*/g, ' ').replace(/\s+/g, ' ').trim();
      const normalizedNoParen = normalizeTherapyName(noParen);
      if (normalizedNoParen && normalizedNoParen !== normalized) accepts.add(normalizedNoParen);
    };

    if (typeof entry === 'string'){
      display = entry;
      addCandidate(entry);
    } else if (Array.isArray(entry)){
      entry.forEach((value, idx)=>{
        if (typeof value !== 'string') return;
        if (!display) display = value;
        addCandidate(value);
      });
    } else if (entry && typeof entry === 'object'){
      if (typeof entry.display === 'string') display = entry.display;
      else if (typeof entry.label === 'string') display = entry.label;
      else if (typeof entry.name === 'string') display = entry.name;
      else if (typeof entry.drug === 'string') display = entry.drug;
      if (typeof entry.placeholder === 'string') placeholder = entry.placeholder;
      ['drug','name','label','display'].forEach(key=>{
        if (typeof entry[key] === 'string') addCandidate(entry[key]);
      });
      if (Array.isArray(entry.accepts)) entry.accepts.forEach(addCandidate);
      if (Array.isArray(entry.aliases)) entry.aliases.forEach(addCandidate);
    }

    if (!placeholder) placeholder = 'Slot vuoto';
    if (!display) display = Array.from(accepts)[0] || '';
    if (!accepts.size && display) addCandidate(display);
    if (!accepts.size) return null;
    expandAcceptsWithDrugAliases(accepts);
    return {accepts, display, placeholder};
  }

  function normalizeTherapyDefinition(cs){
    const therapy = cs?.therapy;
    if (!therapy) return null;
    const entries = Array.isArray(therapy.required)
      ? therapy.required
      : Array.isArray(therapy.slots)
        ? therapy.slots
        : null;
    if (!entries) return null;
    const slots = entries.map(makeTherapySlot).filter(slot=>slot && slot.accepts.size>0);
    if (!slots.length) return null;
    return {slots};
  }

  function getDrugRowByName(name){
    if (typeof name !== 'string') return null;
    return DRUGS_BY_NAME.get(name) || null;
  }

  function normalizeDrugName(value){
    return normalizeTherapyName(value);
  }

  function computeDrugClassMembers(drug){
    const members = [];
    if (!drug) return members;
    const pushMember = raw => {
      if (typeof raw !== 'string') return;
      const trimmed = raw.trim();
      if (trimmed) members.push(trimmed);
    };
    if (Array.isArray(drug.members)) drug.members.forEach(pushMember);
    if (!members.length && typeof drug.drug === 'string'){
      const match = drug.drug.match(/\(([^)]+)\)/);
      if (match && match[1]){
        match[1].split(/[\/;,]/).forEach(pushMember);
      }
    }
    return members.filter((name, idx, arr)=> arr.indexOf(name)===idx);
  }

  function computeDrugNameVariants(drug){
    const variants = new Set();
    if (!drug) return variants;
    const add = raw => {
      if (typeof raw !== 'string') return;
      const normalized = normalizeDrugName(raw);
      if (normalized) variants.add(normalized);
    };
    add(drug.drug);
    if (typeof drug.name === 'string') add(drug.name);
    if (typeof drug.label === 'string') add(drug.label);
    if (Array.isArray(drug.aliases)) drug.aliases.forEach(add);
    if (Array.isArray(drug.synonyms)) drug.synonyms.forEach(add);
    if (Array.isArray(drug.accepts)) drug.accepts.forEach(add);
    return variants;
  }

  function rebuildDrugNameIndex(){
    DRUGS_BY_NAME.clear();
    DRUG_NAME_INDEX.clear();
    DRUGS.forEach(drug=>{
      DRUGS_BY_NAME.set(drug.drug, drug);
      const variants = computeDrugNameVariants(drug);
      const members = computeDrugClassMembers(drug);
      drug._normalizedNames = variants;
      drug._classMembers = members;
      drug._normalizedClassMembers = new Set(members.map(normalizeDrugName).filter(Boolean));
      variants.forEach(name=>{
        if (!DRUG_NAME_INDEX.has(name)) DRUG_NAME_INDEX.set(name, []);
        DRUG_NAME_INDEX.get(name).push(drug);
      });
    });
  }

  function getDrugNormalizedNames(drug){
    if (!drug) return new Set();
    if (drug._normalizedNames instanceof Set) return drug._normalizedNames;
    const variants = computeDrugNameVariants(drug);
    drug._normalizedNames = variants;
    return variants;
  }

  function getDrugNormalizedClassMembers(drug){
    if (!drug) return new Set();
    if (drug._normalizedClassMembers instanceof Set) return drug._normalizedClassMembers;
    const members = computeDrugClassMembers(drug);
    drug._classMembers = members;
    const normalized = new Set(members.map(normalizeDrugName).filter(Boolean));
    drug._normalizedClassMembers = normalized;
    return normalized;
  }

  function expandAcceptsWithDrugAliases(set){
    if (!(set instanceof Set) || set.size===0) return;
    const additions = [];
    set.forEach(name=>{
      const matches = DRUG_NAME_INDEX.get(name);
      if (!matches) return;
      matches.forEach(drug=>{
        getDrugNormalizedNames(drug).forEach(alias=>{ additions.push(alias); });
        getDrugNormalizedClassMembers(drug).forEach(member=>{ additions.push(member); });
      });
    });
    additions.forEach(name=> set.add(name));
  }

  function slotIntersectsDrug(slot, drug){
    if (!slot || !drug) return false;
    const variants = getDrugNormalizedNames(drug);
    if (!slot.accepts || !slot.accepts.size || !variants.size) return false;
    for (const name of variants){
      if (slot.accepts.has(name)) return true;
    }
    return false;
  }

  const caseKeyForTherapy = cs => {
    if (!cs) return null;
    return cs.id || cs.title || `index:${currentCaseIdx}`;
  };

  function ensureTherapyState(cs){
    const key = caseKeyForTherapy(cs);
    if (!key){
      therapyState.caseKey = null;
      therapyState.definition = null;
      therapyState.selections.clear();
      therapyState.locked = false;
      return null;
    }
    if (therapyState.caseKey !== key){
      therapyState.caseKey = key;
      therapyState.definition = normalizeTherapyDefinition(cs);
      therapyState.selections.clear();
      therapyState.locked = false;
    } else if (!therapyState.definition){
      therapyState.definition = normalizeTherapyDefinition(cs);
    }
    return therapyState.definition;
  }

  function forceResetTherapyState(){
    therapyState.caseKey = null;
    therapyState.definition = null;
    therapyState.selections.clear();
    therapyState.locked = false;
    clinicalSelections.clear();
    resetClinicalMatchingProgress();
  }

  function assignTherapySlots(slots, selections){
    const used = new Set();
    const order = Array.from(selections.keys());
    return slots.map(slot=>{
      let match = null;
      for (const name of order){
        const row = getDrugRowByName(name);
        const variants = row ? Array.from(getDrugNormalizedNames(row)) : (()=>{
          const single = normalizeDrugName(name);
          return single ? [single] : [];
        })();
        if (variants.some(v=>used.has(v))) continue;
        if (variants.some(v=>slot.accepts.has(v))){
          match = name;
          variants.forEach(v=>used.add(v));
          break;
        }
      }
      return match;
    });
  }

  function formatTherapySlotFilled(slot, drugName){
    const normalizedDisplay = normalizeTherapyName(slot.display||'');
    const normalizedDrug = normalizeTherapyName(drugName);
    if (slot.display && normalizedDisplay){
      if ((slot.accepts && slot.accepts.has(normalizedDisplay)) || normalizedDisplay.includes(normalizedDrug)){
        return `‚úÖ ${esc(slot.display)}`;
      }
      return `‚úÖ ${esc(drugName)} (${esc(slot.display)})`;
    }
    return `‚úÖ ${esc(drugName)}`;
  }

  function evaluateClinicalCase(cs, selectionOrder){
    if (!cs) return {solved:false, missing:[], matching:null};
    const matching = cs.__matching || {mode:'set', essentials:[], allowExtras:false};
    const essentials = Array.isArray(matching.essentials) ? matching.essentials : [];
    const selections = Array.isArray(selectionOrder) ? selectionOrder.map(id=>String(id)) : [];
    const selectionSet = new Set(selections);
    const missing = essentials.filter(req=> req && req.id && !selectionSet.has(req.id));
    const mode = matching.mode || 'set';
    let solved = false;
    if (mode === 'set'){
      solved = missing.length===0 && essentials.length>0;
    } else {
      const expected = essentials.map(req=>req.id).filter(Boolean);
      solved = expected.every((id, idx)=> selections[idx]===id);
      if (matching.allowExtras===false && selections.length!==expected.length){
        solved = false;
      }
      if (!expected.length) solved = false;
    }
    return {solved, missing, matching};
  }

  function updateClinicalSelectionSummary(){
    if (MODE!=='clinical') return;
    const state = clinicalMatchProgress;
    const slots = state.slots || [];
    const listEl = state.listEl;
    if (listEl && slots.length){
      slots.forEach(slot=>{
        const el = slot.element;
        if (!el) return;
        if (slot.filled){
          el.classList.remove('empty');
          el.classList.add('filled','locked');
          if (slot.labelEl) slot.labelEl.textContent = slot.displayName || slot.requiredId;
        } else {
          el.classList.remove('filled','locked');
          el.classList.add('empty');
          if (slot.labelEl) slot.labelEl.textContent = '';
        }
      });
    }
    const solved = slots.length>0 && slots.every(slot=>slot.filled);
    state.solved = solved;
    const expectedSelections = slots.filter(slot=>slot.filled && slot.matchedId).map(slot=>slot.matchedId);
    state.filledIds = new Set(expectedSelections);
    const currentSelections = Array.from(clinicalSelections);
    if (expectedSelections.length!==currentSelections.length || expectedSelections.some((id,idx)=>currentSelections[idx]!==id)){
      clinicalSelections.clear();
      expectedSelections.forEach(id=> clinicalSelections.add(id));
    }
    if (state.bannerEl){
      state.bannerEl.style.display = solved ? '' : 'none';
    }
    if (state.notesEl){
      if (solved){
        const notes = Array.isArray(state.notes) ? state.notes : [];
        if (notes.length){
          state.notesEl.innerHTML = `<ul>${notes.map(note=>`<li>${formatMultiline(note)}</li>`).join('')}</ul>`;
          state.notesEl.style.display = 'block';
        } else {
          state.notesEl.innerHTML = '';
          state.notesEl.style.display = 'none';
        }
      } else {
        state.notesEl.innerHTML = '';
        state.notesEl.style.display = 'none';
      }
    }
  }

  function syncClinicalSelectionUI(){
    if (MODE!=='clinical') return;
    rightList.querySelectorAll('.item[data-selectable-id]').forEach(el=>{
      const id = el.dataset.selectableId;
      if (id && clinicalSelections.has(id)){
        el.classList.add('matched');
      } else {
        el.classList.remove('matched');
      }
    });
  }

  function updateClinicalUI(){
    if (MODE!=='clinical') return;
    updateClinicalSelectionSummary();
    syncClinicalSelectionUI();
  }

  function toggleClinicalSelection(id){
    if (MODE!=='clinical') return;
    const key = String(id);
    if (!key) return;
    const cs = getCurrentClinicalCase();
    if (!cs) return;
    const caseKey = caseKeyForTherapy(cs);
    if (clinicalMatchProgress.key !== caseKey){
      setupClinicalSlotsPanel(cs);
    }
    if (clinicalMatchProgress.mode === 'set'){
      if (clinicalMatchProgress.solved){
        showClinicalErrorOverlay('‚ùå Farmaco errato!');
        return;
      }
      if (clinicalMatchProgress.filledIds.has(key)){
        showClinicalErrorOverlay('‚ùå Farmaco errato!');
        return;
      }
      const slot = clinicalMatchProgress.slots.find(s=>s.requiredId===key && !s.filled);
      if (slot){
        slot.filled = true;
        slot.matchedId = key;
        const sel = CLINICAL_SELECTABLES_BY_ID.get(key);
        slot.displayName = sel ? sel.name : key;
        clinicalMatchProgress.filledIds.add(key);
        updateClinicalUI();
        return;
      }
      showClinicalErrorOverlay('‚ùå Farmaco errato!');
      if (clinicalMatchProgress.allowExtras && clinicalMatchProgress.listEl){
        // extras opzionali: nessuna azione aggiuntiva richiesta
      }
      return;
    }
    if (clinicalSelections.has(key)) clinicalSelections.delete(key);
    else clinicalSelections.add(key);
    updateClinicalUI();
  }

  function changeClinicalCase(delta){
    if (!CASES.length) return false;
    currentCaseIdx = (currentCaseIdx + delta + CASES.length) % CASES.length;
    clinicalSelections.clear();
    resetClinicalMatchingProgress();
    renderByMode();
    return true;
  }

  function shuffleClinicalCasesInPlace(){
    if (!CASES.length) return false;
    CASES = shuffle(CASES);
    currentCaseIdx = 0;
    clinicalSelections.clear();
    resetClinicalMatchingProgress();
    renderByMode();
    return true;
  }

  function wireClinicalCaseButtons(){
    const hasCases = CASES.length>0;
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnShuffleCase = document.getElementById('btnShuffleCase');
    const btnShowHint = document.getElementById('btnShowHint');
    const btnShowDiagnosis = document.getElementById('btnShowDiagnosis');
    const btnShowFullSolution = document.getElementById('btnShowFullSolution');

    if (btnPrev) btnPrev.onclick = ()=>{ if (!hasCases){ showToast('Carica ./data/clinical.json (Clinica)','bad'); return; } changeClinicalCase(-1); };
    if (btnNext) btnNext.onclick = ()=>{ if (!hasCases){ showToast('Carica ./data/clinical.json (Clinica)','bad'); return; } changeClinicalCase(1); };
    if (btnShuffleCase) btnShuffleCase.onclick = ()=>{
      if (!hasCases){ showToast('Carica ./data/clinical.json (Clinica)','bad'); return; }
      if (shuffleClinicalCasesInPlace()) showToast('Casi rimescolati','mid');
    };
    if (btnShowHint) btnShowHint.onclick = ()=>{
      if (!hasCases){ showToast('Carica ./data/clinical.json (Clinica)','bad'); return; }
      showCaseHint(getCurrentClinicalCase());
    };
    if (btnShowDiagnosis) btnShowDiagnosis.onclick = ()=>{
      if (!hasCases){ showToast('Carica ./data/clinical.json (Clinica)','bad'); return; }
      showCaseDiagnosis(getCurrentClinicalCase());
    };
    if (btnShowFullSolution) btnShowFullSolution.onclick = ()=>{
      if (!hasCases){ showToast('Carica ./data/clinical.json (Clinica)','bad'); return; }
      showCaseFullSolution(getCurrentClinicalCase());
    };
  }

  function analyzeDrugAgainstCase(drugRow, cs, info){
    if (!drugRow || !cs) return {category:'NON', reason:'Dati mancanti', clusters:[], missing:[], contra:[]};
    const clusterInfo = info||getCaseClusterInfo(cs);
    const matches = Array.isArray(drugRow.matches)?drugRow.matches:[];
    const best = new Map();
    matches.forEach(m=>{
      if (!m || m.covers!==true || !m.cluster) return;
      const p = Number(m.priority||1);
      const prev = best.get(m.cluster)||0;
      if (p>prev) best.set(m.cluster,p);
    });
    const relevant = [];
    clusterInfo.allOrdered.forEach(cluster=>{
      const p = best.get(cluster);
      if (p){
        relevant.push({name:cluster, priority:p, essential:clusterInfo.essentialSet.has(cluster)});
      }
    });
    const missingEssentials = clusterInfo.essential.filter(cluster=>!best.has(cluster));
    const drugContraArr = [];
    if (Array.isArray(drugRow.avoid)) drugContraArr.push(...drugRow.avoid);
    if (Array.isArray(drugRow.contra)) drugContraArr.push(...drugRow.contra);
    const drugContraSet = new Set(drugContraArr.filter(Boolean));
    const contraHits = [];
    drugContraSet.forEach(cluster=>{
      if (clusterInfo.allOrdered.includes(cluster) || clusterInfo.contraSet.has(cluster)) contraHits.push(cluster);
    });
    if (clusterInfo.contraSet.has(drugRow.drug)) contraHits.push(drugRow.drug);
    let category = 'NON';
    let reason = '';
    if (missingEssentials.length>0){
      reason = 'Manca: '+missingEssentials.join(', ');
    } else if (contraHits.length>0){
      reason = 'Controindicazione: '+contraHits.join(', ');
    } else if (!clusterInfo.allOrdered.length && !relevant.length){
      reason = 'Nessun cluster definito per il caso';
    } else if (!relevant.length){
      reason = 'Nessuna copertura rilevante';
    } else {
      let score = 0;
      if (clusterInfo.essential.length){
        score = clusterInfo.essential.reduce((min, cluster)=>{
          const p = best.get(cluster)||0;
          return (!p || p<min) ? p : min;
        }, 99);
      } else {
        score = relevant.reduce((max, entry)=>Math.max(max, entry.priority), 0);
      }
      if (score>=3) category='TOP';
      else if (score===2) category='BENE';
      else if (score===1) category='OK';
      else {
        category='NON';
        reason = 'Copertura insufficiente';
      }
    }
    return {category, reason, clusters:relevant, missing:missingEssentials, contra:contraHits, info:clusterInfo};
  }

  const formatCompatCluster = entry => (
    esc(entry.name) +
    (entry.essential ? ' ‚≠ê' : '') +
    (entry.priority ? ` (P${entry.priority})` : '')
  );

  const isPositive = status => status === 'TOP' || status === 'BENE' || status === 'OK';

  function triggerFlash(el){
    if (!el) return;
    el.classList.remove('flash-ok');
    void el.offsetWidth;
    el.classList.add('flash-ok');
    const removeFlash = ()=>{ el.classList.remove('flash-ok'); };
    el.addEventListener('animationend', removeFlash, {once:true});
    setTimeout(removeFlash, 1600);
  }

  function openModal(title, html){
    modalTitle.textContent = title;
    modalBody.innerHTML = html;
    modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
  backdrop.addEventListener('click', closeModal);
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

  /* ===== Caricamento file ===== */
  fileDrugs.onchange = e => {
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader();
    clearError(); clearWarn();
    r.onerror=()=>showError('Impossibile leggere il file farmaci.');
    r.onload=()=>{ try{
      const json=JSON.parse(r.result);
      if(!Array.isArray(json)) throw new Error('File farmaci: atteso un array.');
      DRUGS=json;
      rebuildDrugNameIndex();
      buildCounters();
      prepareFilters();
      forceResetTherapyState();
      renderByMode();
      showToast('Farmaci caricati','ok');
    } catch(err){ showError('Errore farmaci: '+(err.message||err)); } };
    r.readAsText(f,'utf-8');
  };

  if (btnLoadClinical){
    btnLoadClinical.addEventListener('click', ()=>{
      if (fileCases){
        fileCases.value = '';
        fileCases.click();
      }
    });
  }

  fileCases.onchange = e => {
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader();
    const fileName = f.name ? f.name.trim() || 'clinical.json' : 'clinical.json';
    const wasLoaded = clinicalDataLoaded;
    const previousName = clinicalLoadedFileName;
    clearError(); clearWarn();
    r.onerror=()=>{
      clinicalDataLoaded = wasLoaded;
      clinicalLoadedFileName = previousName;
      updateClinicalLoaderStatus();
      showError('Impossibile leggere il file clinical.');
      fileCases.value = '';
    };
    r.onload=()=>{
      try{
        const json=JSON.parse(r.result);
        applyClinicalData(json);
        updateClinicalLoaderStatus(fileName);
        renderByMode();
        showToast('clinical.json caricato','ok');
      } catch(err){
        clinicalDataLoaded = wasLoaded;
        clinicalLoadedFileName = previousName;
        updateClinicalLoaderStatus();
        const msg = (err && err.message === CLINICAL_STRUCTURE_ERROR)
          ? CLINICAL_STRUCTURE_ERROR
          : 'Errore clinical: '+(err && err.message ? err.message : err);
        showError(msg);
      } finally {
        fileCases.value = '';
      }
    };
    r.readAsText(f,'utf-8');
  };

  function buildCounters(){
    rebuildDrugNameIndex();
    countersInit.clear(); countersHit.clear(); lockedDrugs.clear();
    for (const d of DRUGS){
      const init = {top:new Set(), bene:new Set(), ok:new Set()};
      const best = new Map(); // cluster -> maxP (solo covers:true)
      (d.matches||[]).forEach(m=>{
        if (m.covers===true){
          const prev = best.get(m.cluster)||0;
          best.set(m.cluster, Math.max(prev, Number(m.priority||1)));
        }
      });
      for (const [cluster,p] of best){
        init[priorityBucket(p)].add(cluster);
      }
      countersInit.set(d.drug, init);
      countersHit.set(d.drug, {top:new Set(), bene:new Set(), ok:new Set()});
    }
  }
  function remainingCounters(drug){
    const i = countersInit.get(drug); const h = countersHit.get(drug);
    if (!i || !h) return {top:0,bene:0,ok:0};
    return { top:Math.max(0,i.top.size-h.top.size),
             bene:Math.max(0,i.bene.size-h.bene.size),
             ok:Math.max(0,i.ok.size-h.ok.size) };
  }
  function markMatched(drug, cluster){
    const init = countersInit.get(drug); if(!init) return;
    const hit  = countersHit.get(drug);
    if (init.top.has(cluster))  hit.top.add(cluster);
    else if (init.bene.has(cluster)) hit.bene.add(cluster);
    else if (init.ok.has(cluster))   hit.ok.add(cluster);
  }
  function isDrugCompleted(drug){
    const r = remainingCounters(drug);
    return r.top===0 && r.bene===0 && r.ok===0;
  }

  /* ===== Filtri ===== */
  if (searchInput){
    searchInput.addEventListener('input', ()=>{
      if (MODE==='clinical'){
        renderClinicalSelectablesAccordion();
        syncClinicalSelectionUI();
      } else {
        renderByMode();
      }
    });
  }
  [filterCategory, filterCluster].forEach(el=>{
    if (!el) return;
    el.addEventListener('input', ()=>renderByMode());
  });

  function prepareFilters(){
    // Filtro categoria: usa i 12 gruppi fissi
    filterCategory.innerHTML =
      `<option value="">Categoria farmaco: tutte</option>` +
      AB_GROUPS_ORDER.map(g=>`<option>${esc(g)}</option>`).join('');

    // Filtro cluster: dinamico (dai dati + default)
    const found = new Set(DEFAULT_CLUSTERS);
    DRUGS.forEach(r => (r.matches||[]).forEach(m => found.add(m.cluster)));
    filterCluster.innerHTML =
      `<option value="">Cluster: tutti</option>` +
      Array.from(found).sort((a,b)=>a.localeCompare(b)).map(c=>`<option>${esc(c)}</option>`).join('');
  }

  function filterDrugsForList(){
    const rawQuery = searchInput ? searchInput.value || '' : '';
    bugDrugSearchQuery = normalizeSearchValue(rawQuery);
    bugDrugSearchMatches.clear();
    const selectedBucket = filterCategory.value || '';
    const rows = DRUGS.filter(r=>{
      if (selectedBucket && bucketAntibiotic(r.category)!==selectedBucket) return false;
      if (bugDrugSearchQuery){
        const hay = getDrugSearchHaystack(r);
        if (!hay.includes(bugDrugSearchQuery)) return false;
        bugDrugSearchMatches.add(r.drug);
      }
      return true;
    });
    if (!bugDrugSearchQuery){
      bugDrugSearchMatches.clear();
    }
    return rows;
  }

  /* ===== Modalit√† ===== */
  modeSelect.onchange = ()=>{ MODE = modeSelect.value; renderByMode(); };

  function renderByMode(){
    if (rootContainer){
      rootContainer.classList.toggle('mode-clinica', MODE==='clinical');
      rootContainer.classList.toggle('mode-bugdrug', MODE==='covers');
      rootContainer.classList.toggle('mode-impara', MODE==='learn');
    }
    if (MODE!=='learn'){
      setLearnInfoVisible(false);
    }
    if (MODE==='clinical'){
      if (clinicalLoader){
        const showUpload = CLINICAL_UPLOAD_ALLOWED;
        clinicalLoader.hidden = !showUpload;
        clinicalLoader.style.display = showUpload ? 'flex' : 'none';
      }
      if (fileDrugs) fileDrugs.style.display = 'none';
      updateClinicalLoaderStatus();
    } else {
      if (clinicalLoader) clinicalLoader.style.display = 'none';
      if (fileDrugs) fileDrugs.style.display = '';
    }
    board.className = (MODE==='learn') ? 'board' : 'board two';
    if (MODE==='clinical'){
      filterCategory.disabled = true;
      filterCluster.disabled = true;
      ensureClinicalAutoLoad();
      leftTitle.textContent='Caso clinico';
      rightTitle.textContent='Selezionabili';
      renderCaseLeft();
      renderClinicalSelectablesAccordion();
      updateClinicalUI();
    } else if (MODE==='learn'){
      filterCategory.disabled = false;
      filterCluster.disabled = false;
      forceResetTherapyState();
      leftTitle.textContent='Impara ‚Äî Farmaci'; rightTitle.textContent=''; rightList.innerHTML='';
      renderLearnTable();
    } else { // covers
      filterCategory.disabled = false;
      filterCluster.disabled = false;
      forceResetTherapyState();
      leftTitle.textContent='Farmaci (raggruppati)'; rightTitle.textContent='Cluster';
      renderDrugsAccordionLeft_ABGroups(); renderClustersRight();
    }
  }

  /* ===== Copre ===== */
  function drugItemHTML(r, withCounters, isSearchHit=false){
    const rem = remainingCounters(r.drug);
    const cnts = (withCounters)
      ? `<div class="counters">
           <span class="cnt top" title="TOP rimanenti">TOP ${rem.top}</span>
           <span class="cnt bene" title="BENE rimanenti">BENE ${rem.bene}</span>
           <span class="cnt ok" title="OK rimanenti">OK ${rem.ok}</span>
         </div>`
      : '';
    const classes = ['item'];
    if (MODE==='covers' && isDrugCompleted(r.drug)) classes.push('locked');
    if (isSearchHit) classes.push('search-hit');
    return `<div class="${classes.join(' ')}" data-drug="${esc(r.drug)}" tabindex="0">
      <div class="title">${esc(r.drug)}</div>
      ${cnts}
      <div class="info" data-solv-drug="${esc(r.drug)}">‚ìò</div>
    </div>`;
  }

  function renderDrugsAccordionLeft_ABGroups(){
    const rows = filterDrugsForList();
    const queryActive = !!bugDrugSearchQuery;
    if (!rows.length){
      if (!DRUGS.length){
        leftList.innerHTML = `<div class="item" style="pointer-events:none">Carica i farmaci per iniziare.</div>`;
      } else if (queryActive){
        leftList.innerHTML = `<div class="item" style="pointer-events:none">Nessun risultato.</div>`;
      } else {
        leftList.innerHTML = `<div class="item" style="pointer-events:none">Nessun elemento da mostrare.</div>`;
      }
      return;
    }

    const buckets = new Map(AB_GROUPS_ORDER.map(g=>[g,[]]));
    rows.forEach(r=>{
      const bucket = bucketAntibiotic(r.category);
      if (!buckets.has(bucket)) buckets.set(bucket, []);
      buckets.get(bucket).push(r);
    });

    const html = AB_GROUPS_ORDER.map(g=>{
      const items = buckets.get(g)||[];
      const groupHasMatches = queryActive && items.some(r=>bugDrugSearchMatches.has(r.drug));
      const detailsClasses = groupHasMatches ? ' class="has-search-hit"' : '';
      const shouldOpen = queryActive ? groupHasMatches : g==='Œ≤-lattamici';
      const openAttr = shouldOpen ? ' open' : '';
      const inner = items.length
        ? items.map(r=>drugItemHTML(r, MODE==='covers', queryActive && bugDrugSearchMatches.has(r.drug))).join('')
        : `<div class="item" style="pointer-events:none">‚Äî</div>`;
      return `<details${detailsClasses}${openAttr}><summary>${esc(g)}</summary><div class="group">${inner}</div></details>`;
    }).join('');

    leftList.innerHTML = html || `<div class="item" style="pointer-events:none">Carica i farmaci per iniziare.</div>`;

    leftList.querySelectorAll('.item[data-drug]').forEach(el=>{
      el.addEventListener('click', (e)=>{ if(e.target.classList.contains('info')) return; selectDrug(el.dataset.drug, el); });
      el.addEventListener('keydown', e=>{ if((e.key==='Enter'||e.key===' ') && !e.target.classList.contains('info')){ selectDrug(el.dataset.drug, el); e.preventDefault(); }});
    });
    leftList.querySelectorAll('.info[data-solv-drug]').forEach(el=>{
      el.addEventListener('click', ()=> showDrugSolution(el.dataset.solvDrug));
    });
  }

  function renderClustersRight(){
    const filter = (filterCluster.value||'').toLowerCase();
    const clusters = DEFAULT_CLUSTERS.filter(c => !filter || c.toLowerCase().includes(filter));
    rightList.innerHTML = clusters.map(c=>{
      const tagClass = bugDrugClusterTagClass(c);
      const classes = ['item', 'cluster-card', clusterClass(c)];
      if (tagClass) classes.push(tagClass);
      return `<div class="${classes.join(' ')}" data-cluster="${esc(c)}" tabindex="0">
        <div class="title">${esc(c)}</div>
        <div class="info" data-solv-cluster="${esc(c)}">‚ìò</div>
      </div>`;
    }).join('');
    rightList.querySelectorAll('.item').forEach(el=>{
      el.addEventListener('click', (e)=>{ if(e.target.classList.contains('info')) return; selectCluster(el.dataset.cluster, el); });
      el.addEventListener('keydown', e=>{ if((e.key==='Enter'||e.key===' ') && !e.target.classList.contains('info')){ selectCluster(el.dataset.cluster, el); e.preventDefault(); }});
    });
    rightList.querySelectorAll('.info[data-solv-cluster]').forEach(el=>{
      el.addEventListener('click', ()=> showClusterSolution(el.dataset.solvCluster));
    });
  }

  let pendingDrug=null, pendingDrugEl=null, pendingCluster=null, pendingClusterEl=null;

  function selectDrug(drug, el){
    if (pendingDrugEl) pendingDrugEl.classList.remove('selected');
    pendingDrug=drug; pendingDrugEl=el; el.classList.add('selected');
    tryResolve();
  }
  function selectCluster(cluster, el){
    if (pendingClusterEl) pendingClusterEl.classList.remove('selected');
    pendingCluster=cluster; pendingClusterEl=el; el.classList.add('selected');
    tryResolve();
  }

  function tryResolve(){
    if (!pendingDrug || !pendingCluster) return;

    const row = getDrugRowByName(pendingDrug);
    const links=(row&&row.matches)||[];
    const coverHit = links
      .filter(m=>m.cluster===pendingCluster && m.covers===true)
      .sort((a,b)=>Number(b.priority||1)-Number(a.priority||1))[0]; // migliore priorit√†

    // not_covers rimane dormiente ‚Äî la UI non lo usa

    if (coverHit){
      // contatori + feedback per priorit√†
      markMatched(pendingDrug, pendingCluster);
      updateDrugCounters(pendingDrug);
      const p = Number(coverHit.priority||1);
      const status = (p>=3) ? 'TOP' : (p===2) ? 'BENE' : 'OK';
      const msg = status==='TOP' ? 'üèÜ TOP' : status==='BENE' ? 'üëç BENE' : '‚úÖ OK';
      showToast(msg,'ok');

      if (MODE==='covers' && pendingDrugEl){
        triggerFlash(pendingDrugEl);
      }
      if (MODE==='covers' && pendingClusterEl && isPositive(status)){
        triggerFlash(pendingClusterEl);
      }

      pendingDrugEl.classList.add('matched');
      pendingClusterEl.classList.add('matched');

      if (isDrugCompleted(pendingDrug)){
        lockedDrugs.add(pendingDrug);
        pendingDrugEl.classList.add('locked');
      }
    } else {
      showToast('‚ùå Sbagliato','bad');
    }

    pendingDrugEl?.classList.remove('selected');
    pendingClusterEl?.classList.remove('selected');
    pendingDrug=pendingCluster=null; pendingDrugEl=pendingClusterEl=null;
  }

  function updateDrugCounters(drug){
    const el = leftList.querySelector(`[data-drug="${CSS.escape(drug)}"]`);
    if (!el) return;
    const rem = remainingCounters(drug);
    const cnt = el.querySelector('.counters');
    if (cnt){
      cnt.innerHTML = `
        <span class="cnt top" title="TOP rimanenti">TOP ${rem.top}</span>
        <span class="cnt bene" title="BENE rimanenti">BENE ${rem.bene}</span>
        <span class="cnt ok" title="OK rimanenti">OK ${rem.ok}</span>
      `;
    }
  }

  /* ===== Soluzioni (icone ‚ìò) ===== */
  function showDrugSolution(name){
    const d = getDrugRowByName(name);
    if(!d){ openModal('Soluzione', '<div>Farmaco non trovato.</div>'); return; }
    const best = new Map();
    (d.matches||[]).forEach(m=>{
      if (m.covers!==true) return;
      const p = Number(m.priority||1);
      const prev = best.get(m.cluster)||0;
      if (p>prev) best.set(m.cluster,p);
    });
    const cov = Array.from(best.entries()).map(([c,p])=>({cluster:c,p}));
    const ncv = (d.matches||[]).filter(m=>m.covers===false).map(m=>m.cluster);
    const av  = d.avoid||[];
    const html = `
      <div><b>${esc(d.drug)}</b> <small>${esc(d.category||'')}</small></div>
      <div style="margin-top:8px"><b>Copre:</b></div>
      <div class="chips">${cov.map(x=>`<span class="chip">${esc(x.cluster)} (P${x.p})</span>`).join('')||'‚Äî'}</div>
      ${ncv.length? `<div style="margin-top:8px"><b>Non copre (esplicito):</b></div><div class="chips">${ncv.map(c=>`<span class="chip">${esc(c)}</span>`).join('')}</div>`:''}
      ${av.length?  `<div style="margin-top:8px"><b>Avoid:</b></div><div class="chips">${av.map(c=>`<span class="chip">${esc(c)}</span>`).join('')}</div>`:''}
      ${d.notes? `<div style="margin-top:8px"><small>${esc(d.notes)}</small></div>`:''}
      ${d.source? `<div style="margin-top:4px"><small>Fonte: ${esc(d.source)}</small></div>`:''}
    `;
    openModal('Soluzione ‚Äî Farmaco', html);
  }

  function showClusterSolution(cluster){
    const okDrugs = DRUGS.filter(d=> (d.matches||[]).some(m=>m.cluster===cluster && m.covers===true));
    const badDrugs = DRUGS.filter(d=> (d.avoid||[]).includes(cluster) || (d.matches||[]).some(m=>m.cluster===cluster && m.covers===false));
    const html = `
      <div><b>${esc(cluster)}</b></div>
      <div style="margin-top:10px"><b>Farmaci che coprono:</b></div>
      <div class="chips">${okDrugs.map(d=>`<span class="chip">${esc(d.drug)}</span>`).join('')||'‚Äî'}</div>
      <div style="margin-top:10px"><b>Farmaci ‚Äúnon copre‚Äù / avoid:</b></div>
      <div class="chips">${badDrugs.map(d=>`<span class="chip">${esc(d.drug)}</span>`).join('')||'‚Äî'}</div>
    `;
    openModal('Soluzione ‚Äî Cluster', html);
  }

  /* ===== Clinica ===== */
  function renderCaseLeft(){
    const cs = getCurrentClinicalCase();
    if (cs){
      leftList.innerHTML = renderCaseCard(cs);
      wireClinicalCaseButtons();
      setupClinicalSlotsPanel(cs);
    } else {
      leftList.innerHTML = `<div class="item" style="pointer-events:none">Usa il bottone ‚ÄúCarica ./data/clinical.json‚Äù per avviare la modalit√† Clinica.</div>`;
      resetClinicalMatchingProgress();
    }
  }
  function renderCaseCard(cs){
    return `<div class="item" style="cursor:default">
      <div class="title">${esc(cs.__title||cs.title||'Caso')}</div>
      <div class="case-vignette">${formatMultiline(cs.__vignette||cs.vignette||'')}</div>
      <div class="case-actions">
        <button class="btn" id="btnShowHint">üí° Hint</button>
        <button class="btn" id="btnShowDiagnosis">üß© Diagnosi</button>
        <button class="btn" id="btnShowFullSolution">üß™ Soluzione</button>
      </div>
      <div class="case-actions">
        <button class="btn" id="btnPrev">‚èÆÔ∏è Precedente</button>
        <button class="btn" id="btnNext">‚è≠Ô∏è Successivo</button>
        <button class="btn" id="btnShuffleCase">üîÄ Reshuffle</button>
      </div>
      <div id="clin-slots">
        <div id="clin-slots-banner" class="clin-slot-banner">‚úÖ Terapia corretta</div>
        <div id="clin-slot-list" class="clin-slot-list"></div>
      </div>
      <div id="clin-notes"></div>
    </div>`;
  }

  function resetClinicalMatchingProgress(){
    clinicalMatchProgress.key = null;
    clinicalMatchProgress.mode = 'set';
    clinicalMatchProgress.allowExtras = false;
    clinicalMatchProgress.slots = [];
    clinicalMatchProgress.filledIds = new Set();
    clinicalMatchProgress.solved = false;
    clinicalMatchProgress.notes = [];
    clinicalMatchProgress.container = null;
    clinicalMatchProgress.listEl = null;
    clinicalMatchProgress.bannerEl = null;
    clinicalMatchProgress.notesEl = null;
  }

  function createClinicalSlotElement(slot){
    const el = document.createElement('div');
    el.className = 'clin-slot empty';
    el.dataset.requiredId = slot.requiredId;
    const bullet = document.createElement('span');
    bullet.className = 'clin-slot-bullet';
    bullet.textContent = '‚Ä¢';
    const label = document.createElement('span');
    label.className = 'clin-slot-label';
    label.textContent = '';
    el.append(bullet, label);
    slot.element = el;
    slot.labelEl = label;
    return el;
  }

  function setupClinicalSlotsPanel(cs){
    if (!cs){
      resetClinicalMatchingProgress();
      return;
    }
    const key = caseKeyForTherapy(cs);
    clinicalMatchProgress.key = key;
    const matching = cs.__matching || {mode:'set', essentials:[], allowExtras:false};
    const essentials = Array.isArray(matching.essentials) ? matching.essentials : [];
    clinicalMatchProgress.mode = matching.mode || 'set';
    clinicalMatchProgress.allowExtras = matching.allowExtras === true;
    clinicalMatchProgress.notes = Array.isArray(cs.__notesOnCompletion) ? cs.__notesOnCompletion : [];
    clinicalMatchProgress.filledIds = new Set();
    clinicalMatchProgress.solved = false;
    clinicalMatchProgress.slots = essentials.map(req=>{
      const id = req && req.id ? String(req.id) : '';
      if (!id) return null;
      return {
        requiredId: id,
        type: req.type || 'drug',
        filled: false,
        matchedId: null,
        displayName: '',
        element: null,
        labelEl: null
      };
    }).filter(Boolean);

    const container = document.getElementById('clin-slots');
    const listEl = document.getElementById('clin-slot-list');
    const bannerEl = document.getElementById('clin-slots-banner');
    const notesEl = document.getElementById('clin-notes');

    clinicalMatchProgress.container = container;
    clinicalMatchProgress.listEl = listEl;
    clinicalMatchProgress.bannerEl = bannerEl;
    clinicalMatchProgress.notesEl = notesEl;

    if (bannerEl) bannerEl.style.display = 'none';
    if (notesEl){
      notesEl.innerHTML = '';
      notesEl.style.display = 'none';
    }
    if (listEl){
      if (!clinicalMatchProgress.slots.length){
        listEl.innerHTML = `<div class="clin-slot-empty-message">Nessun essenziale definito.</div>`;
      } else {
        listEl.innerHTML = '';
        clinicalMatchProgress.slots.forEach(slot=>{
          const el = createClinicalSlotElement(slot);
          listEl.appendChild(el);
        });
      }
    }
    clinicalSelections.clear();
    updateClinicalSelectionSummary();
  }

  function showClinicalErrorOverlay(message){
    showToast(message, 'bad', 2400);
  }

  function clinicalSelectableItemHTML(sel, options = {}){
    if (!sel) return '';
    const opts = options || {};
    const selected = clinicalSelections.has(sel.id) ? ' matched' : '';
    const typeLabel = sel.type==='class'
      ? 'Classe'
      : sel.type==='drug'
        ? 'Farmaco'
        : sel.type ? sel.type.charAt(0).toUpperCase()+sel.type.slice(1) : 'Opzione';
    const metaParts = [typeLabel];
    if (opts.includeSubgroup && sel.subgroup){
      metaParts.push(sel.subgroup);
    }
    const subtitle = metaParts.filter(Boolean).map(part=>esc(part)).join(' ‚Ä¢ ');
    const subtitleHtml = subtitle ? `<div class="subtitle">${subtitle}</div>` : '';
    return `<div class="item${selected}" data-selectable-id="${esc(sel.id)}" tabindex="0">
      <div class="title">${esc(sel.name)}</div>
      ${subtitleHtml}
    </div>`;
  }

  function renderClinicalSelectablesAccordion(){
    if (!CLINICAL_SELECTABLES.length){
      rightList.innerHTML = `<div class="item" style="pointer-events:none">Usa il bottone ‚ÄúCarica ./data/clinical.json‚Äù per mostrare i selezionabili.</div>`;
      return;
    }
    const items = filterClinicalSelectables();
    if (!items.length){
      rightList.innerHTML = `<div class="item" style="pointer-events:none">Nessun elemento trovato.</div>`;
      return;
    }
    const groupsMap = new Map();
    items.forEach(sel=>{
      const group = sel.group || 'Senza gruppo';
      if (!groupsMap.has(group)) groupsMap.set(group, []);
      groupsMap.get(group).push(sel);
    });
    const groupsOrder = (()=>{
      const order = CLINICAL_GROUP_ORDER.slice();
      const seen = new Set(order);
      groupsMap.forEach((_, group)=>{
        if (!seen.has(group)){
          order.push(group);
          seen.add(group);
        }
      });
      return order;
    })();
    let openFirst = true;
    const html = groupsOrder.map(groupName=>{
      const groupItems = groupsMap.get(groupName);
      if (!groupItems || !groupItems.length) return '';
      const subOrder = CLINICAL_SUBGROUP_ORDER.get(groupName) || [];
      const useSubgroups = subOrder.length>0 && groupItems.some(sel=>!!sel.subgroup);
      let body = '';
      if (useSubgroups){
        const subMap = new Map();
        const noSubItems = [];
        groupItems.forEach(sel=>{
          if (sel.subgroup){
            if (!subMap.has(sel.subgroup)) subMap.set(sel.subgroup, []);
            subMap.get(sel.subgroup).push(sel);
          } else {
            noSubItems.push(sel);
          }
        });
        const orderedSubgroups = subOrder.slice();
        const seenSubs = new Set(orderedSubgroups);
        subMap.forEach((_, key)=>{
          if (!seenSubs.has(key)){
            orderedSubgroups.push(key);
            seenSubs.add(key);
          }
        });
        const sections = orderedSubgroups.map(subName=>{
          const list = subMap.get(subName);
          if (!list || !list.length) return '';
          const entries = list.map(sel=>clinicalSelectableItemHTML(sel)).join('');
          return `<details class="clinical-subgroup"><summary>${esc(subName)}</summary><div class="clinical-subgroup-items">${entries}</div></details>`;
        }).filter(Boolean);
        if (noSubItems.length){
          const entries = noSubItems.map(sel=>clinicalSelectableItemHTML(sel)).join('');
          sections.unshift(`<div class="clinical-subgroup-items">${entries}</div>`);
        }
        body = sections.join('');
        if (!body){
          body = groupItems.map(sel=>clinicalSelectableItemHTML(sel)).join('');
        }
      } else {
        body = groupItems.map(sel=>clinicalSelectableItemHTML(sel, {includeSubgroup:true})).join('');
      }
      const openAttr = openFirst ? ' open' : '';
      openFirst = false;
      return `<details class="clinical-group"${openAttr}><summary>${esc(groupName)}</summary><div class="group">${body}</div></details>`;
    }).filter(Boolean).join('');
    rightList.innerHTML = html || `<div class="item" style="pointer-events:none">Nessun elemento trovato.</div>`;

    rightList.querySelectorAll('.item[data-selectable-id]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const id = el.dataset.selectableId;
        if (!id) return;
        toggleClinicalSelection(id);
      });
      el.addEventListener('keydown', e=>{
        if (e.key==='Enter' || e.key===' '){
          e.preventDefault();
          el.click();
        }
      });
    });
  }

  function scoreDrugAgainstCase(drugRow, cs){
    const analysis = analyzeDrugAgainstCase(drugRow, cs);
    const base = {status:analysis.category, reason:analysis.reason||'', details:analysis, acceptSelection:true};
    if (analysis.category!=='NON') return base;

    const definition = ensureTherapyState(cs);
    const slots = definition?.slots || [];
    const classMembersNorm = getDrugNormalizedClassMembers(drugRow);
    if (!drugRow || !slots.length || !classMembersNorm.size){
      return {status:'SBAGLIATO', reason:analysis.reason||'', details:analysis, acceptSelection:false, toastKind:'bad'};
    }

    for (const slot of slots){
      if (!slot || !slot.accepts || !slot.accepts.size) continue;
      if (!slotIntersectsDrug(slot, drugRow)) continue;
      const members = drugRow._classMembers || [];
      let suggestion = '';
      let matchedMember = false;
      const normalizedDisplay = normalizeDrugName(slot.display||'');
      if (normalizedDisplay && classMembersNorm.has(normalizedDisplay) && slot.accepts.has(normalizedDisplay)){
        suggestion = slot.display || members.find(Boolean) || '';
        matchedMember = true;
      }
      if (!matchedMember){
        for (const member of members){
          const norm = normalizeDrugName(member);
          if (slot.accepts.has(norm)){
            suggestion = member;
            matchedMember = true;
            break;
          }
        }
      }
      if (!matchedMember) continue;
      const toast = suggestion ? `‚úÖ Classe ok. Scegli ${suggestion}.` : '‚úÖ Classe ok, specifica la molecola.';
      const reason = suggestion ? `Scegli ${suggestion}` : 'Specificare la molecola della classe.';
      return {status:'OK', reason, details:analysis, acceptSelection:false, toastMessage:toast, toastKind:'mid'};
    }

    return {status:'SBAGLIATO', reason:analysis.reason||'', details:analysis, acceptSelection:false, toastKind:'bad'};
  }

  function showCaseDiagnosis(cs){
    if (!cs){ showToast('Caso non disponibile','bad'); return; }
    const diag = cs?.__diagnosis || cs?.displayDiagnosis || cs?.diagnosis || 'Diagnosi non disponibile.';
    const html = `
      <div><b>${esc(cs?.__title||cs?.title||'Caso')}</b></div>
      <div style="margin-top:8px">${formatMultiline(diag)}</div>
    `;
    openModal('Diagnosi', html);
  }

  function showCaseHint(cs){
    if (!cs){ showToast('Caso non disponibile','bad'); return; }
    const hintText = (()=>{
      const hints = Array.isArray(cs?.__hints) && cs.__hints.length ? cs.__hints : cs?.hints;
      const first = pickFirstString(hints);
      if (first) return first;
      const fallback = cleanString(cs?.hint);
      return fallback;
    })();
    if (hintText){
      const html = `
        <div><b>${esc(cs?.__title||cs?.title||'Caso')}</b></div>
        <div style="margin-top:8px">${formatMultiline(hintText)}</div>
      `;
      openModal('Hint', html);
    } else {
      openModal('Hint', '<div>Nessun hint disponibile</div>');
    }
  }

  function showCaseCompatibility(cs){
    if (!DRUGS.length){ showToast('Carica i farmaci','bad'); return; }
    const info = getCaseClusterInfo(cs);
    const knownClusters = new Set();
    DRUGS.forEach(d=> (d.matches||[]).forEach(m=>{ if (m && m.covers===true && m.cluster) knownClusters.add(m.cluster); }));
    const missingClusters = info.allOrdered.filter(cluster=>cluster && !knownClusters.has(cluster));
    if (missingClusters.length){
      const key = cs.id || cs.title || 'case';
      const signature = missingClusters.join('|');
      if (warnedMissingClusters.get(key)!==signature){
        console.warn('Cluster non mappati per il caso', key, missingClusters);
        warnedMissingClusters.set(key, signature);
      }
    }
    const groups = {TOP:[], BENE:[], OK:[], NON:[]};
    DRUGS.forEach(drug=>{
      const result = analyzeDrugAgainstCase(drug, cs, info);
      (groups[result.category]||groups.NON).push({drug, result});
    });
    Object.keys(groups).forEach(key=>{
      groups[key].sort((a,b)=>a.drug.drug.localeCompare(b.drug.drug));
    });
    const sections = [
      {key:'TOP', label:'TOP'},
      {key:'BENE', label:'BENE'},
      {key:'OK', label:'OK'},
      {key:'NON', label:'NON indicati'}
    ].map(({key,label})=>{
      const items = groups[key]||[];
      const list = items.length
        ? `<ul>${items.map(({drug,result})=>{
            const clusters = result.clusters.length
              ? `<span class="compat-clusters">${result.clusters.map(formatCompatCluster).join(', ')}</span>`
              : '';
            const reason = (key==='NON' && result.reason)
              ? `<span class="compat-reason">${esc(result.reason)}</span>`
              : '';
            return `<li><b>${esc(drug.drug)}</b>${clusters}${reason}</li>`;
          }).join('')}</ul>`
        : `<div class="compat-empty">‚Äî</div>`;
      return `<div class="compat-section"><h4>${label}</h4>${list}</div>`;
    }).join('');
    const essentialsHtml = info.essential.length
      ? `<div style="margin-top:12px"><b>Cluster essenziali</b></div><div class="chips">${info.essential.map(name=>`<span class="chip">${esc(name)} ‚≠ê</span>`).join('')}</div>`
      : '';
    const optionalHtml = info.optional.length
      ? `<div style="margin-top:12px"><b>Altri cluster correlati</b></div><div class="chips">${info.optional.map(name=>`<span class="chip">${esc(name)}</span>`).join('')}</div>`
      : '';
    const header = `<div><b>${esc(cs.title||'Caso')}</b></div>`;
    openModal('Compatibilit√† farmaci', `${header}${essentialsHtml}${optionalHtml}${sections}`);
  }

  function showCaseFullSolution(cs){
    if (!cs){ showToast('Caso non disponibile','bad'); return; }
    const header = `<div><b>${esc(cs?.__title||cs?.title||'Caso')}</b></div>`;
    const recs = Array.isArray(cs?.__recommended) ? cs.__recommended : [];
    if (!recs.length){
      openModal('Soluzione', `${header}<div style="margin-top:8px">Nessuna raccomandazione disponibile.</div>`);
      return;
    }
    const list = `<ul class="solution-list">${recs.map(rec=>{
      const regimen = Array.isArray(rec.regimen) && rec.regimen.length
        ? `<div><strong>Regime</strong>: ${rec.regimen.map(esc).join(', ')}</div>`
        : '';
      const setting = rec.setting ? `<div><strong>Setting</strong>: ${esc(rec.setting)}</div>` : '';
      const rationale = rec.rationale ? `<div><strong>Razionale</strong>: ${esc(rec.rationale)}</div>` : '';
      const source = rec.source ? `<div><small>Fonte: ${esc(rec.source)}</small></div>` : '';
      const body = [regimen, setting, rationale, source].filter(Boolean).join('') || '‚Äî';
      return `<li>${body}</li>`;
    }).join('')}</ul>`;
    openModal('Soluzione', `${header}${list}`);
  }

  /* ===== Impara ===== */
  function renderLearnTable(){
    const rows = filterDrugsForList();
    leftList.innerHTML = `
      <div class="learn-table-wrap">
        <table class="learn-table">
          <thead>
            <tr class="learn-table-title print-only"><th colspan="5">Contagious ¬©</th></tr>
            <tr><th>Farmaco</th><th>Categoria</th><th>Coperture (priorit√†)</th><th>Non copre / Avoid</th><th>Note / Fonte</th></tr>
          </thead>
          <tbody>
            ${rows.map(r=>{
              const best = new Map();
              (r.matches||[]).forEach(m=>{
                if (m.covers===true){
                  const prev = best.get(m.cluster)||0;
                  best.set(m.cluster, Math.max(prev, Number(m.priority||1)));
                }
              });
              const cov = Array.from(best.entries())
                  .map(([c,p])=>`${esc(c)} <small>(P${p})</small>`).join('<br>');
              const ncv=(r.matches||[]).filter(m=>m.covers===false).map(m=>esc(m.cluster)).join(', ');
              const av=(r.avoid||[]).map(esc).join(', ');
              return `<tr>
                <td><b>${esc(r.drug)}</b></td>
                <td>${esc(r.category||'')}</td>
                <td>${cov||'‚Äî'}</td>
                <td>${[ncv,av].filter(Boolean).join('<br>')||'‚Äî'}</td>
                <td>${r.notes?esc(r.notes):''}${r.source?`<br><small>Fonte: ${esc(r.source)}</small>`:''}</td>
              </tr>`;
            }).join('')}
          </tbody>
          <tfoot>
            <tr class="learn-table-disclaimer print-only"><td colspan="5">Strumento formativo: non fornisce diagnosi/terapie. L‚Äôutilizzo clinico richiede verifica su fonti ufficiali e responsabilit√† professionale. Uso non commerciale: non destinato alla vendita n√© a fini di lucro. ¬© 2025 David Vigilanti ‚Äî MedGramo. Leggi la <a href="LICENSE">LICENSE</a>.</td></tr>
          </tfoot>
        </table>
      </div>`;
  }

  /* ===== Azioni comuni ===== */
  if (btnReshuffleTop){
    btnReshuffleTop.onclick = ()=>{
      if (MODE==='clinical'){
        if (shuffleClinicalCasesInPlace()) showToast('Casi rimescolati','mid');
      } else if (MODE==='learn'){
        showToast('La tabella non si rimescola','mid');
      }
      // in "covers" non rimescola (per ora)
    };
  }

  if (btnPrintPDF){
    btnPrintPDF.addEventListener('click', (event)=>{
      if (MODE !== 'learn'){ window.print(); return; }
      if (!isIOSDevice()){ window.print(); return; }

      event.preventDefault();

      const sourceTable = document.querySelector('.learn-table');
      if (!sourceTable){ window.print(); return; }

      const existingRoot = document.getElementById('print-snapshot');
      if (existingRoot){ existingRoot.remove(); }

      const headerRow = sourceTable.tHead ? sourceTable.tHead.querySelector('tr:not(.print-only)') : null;
      let sampleRow = headerRow;
      if (!sampleRow && sourceTable.tBodies && sourceTable.tBodies.length){
        const firstBody = sourceTable.tBodies[0];
        if (firstBody && firstBody.rows && firstBody.rows.length){
          sampleRow = firstBody.rows[0];
        }
      }
      const columnCount = sampleRow ? sampleRow.cells.length : 5;
      const disclaimerSource = sourceTable.tFoot ? sourceTable.tFoot.querySelector('td') : null;
      const disclaimerText = disclaimerSource
        ? disclaimerSource.textContent.trim()
        : `${DEFAULT_DISCLAIMER_TEXT} Leggi la LICENSE`;

      const printRoot = document.createElement('div');
      printRoot.id = 'print-snapshot';
      printRoot.setAttribute('aria-hidden', 'true');
      printRoot.hidden = true;

      const table = document.createElement('table');
      table.className = 'learn-print-table';

      const thead = document.createElement('thead');
      const titleRow = document.createElement('tr');
      titleRow.className = 'print-snapshot-title';
      const titleCell = document.createElement('th');
      titleCell.setAttribute('colspan', String(columnCount));
      titleCell.textContent = 'Contagious ¬©';
      titleRow.appendChild(titleCell);
      thead.appendChild(titleRow);

      if (headerRow){
        thead.appendChild(headerRow.cloneNode(true));
      }

      table.appendChild(thead);

      if (sourceTable.tBodies && sourceTable.tBodies[0]){
        table.appendChild(sourceTable.tBodies[0].cloneNode(true));
      }

      const tfoot = document.createElement('tfoot');
      const footRow = document.createElement('tr');
      footRow.className = 'print-snapshot-disclaimer';
      const footCell = document.createElement('td');
      footCell.setAttribute('colspan', String(columnCount));
      footCell.textContent = disclaimerText;
      footRow.appendChild(footCell);
      tfoot.appendChild(footRow);
      table.appendChild(tfoot);

      printRoot.appendChild(table);
      document.body.appendChild(printRoot);
      printRoot.hidden = false;
      document.body.classList.add('print-snapshot-active');

      let cleanedUp = false;
      const previousAfterPrint = window.onafterprint;
      let fallbackTimer = null;
      const mediaQueryList = typeof window.matchMedia === 'function' ? window.matchMedia('print') : null;
      const mediaListener = (event)=>{
        if (!event.matches){
          cleanup();
        }
      };

      const cleanup = ()=>{
        if (cleanedUp) return;
        cleanedUp = true;
        if (fallbackTimer) window.clearTimeout(fallbackTimer);
        if (printRoot.parentNode) printRoot.parentNode.removeChild(printRoot);
        document.body.classList.remove('print-snapshot-active');
        window.onafterprint = previousAfterPrint;
        if (mediaQueryList){
          if (typeof mediaQueryList.removeEventListener === 'function'){
            mediaQueryList.removeEventListener('change', mediaListener);
          } else if (typeof mediaQueryList.removeListener === 'function'){
            mediaQueryList.removeListener(mediaListener);
          }
        }
      };

      window.onafterprint = (event)=>{
        if (typeof previousAfterPrint === 'function'){
          try {
            previousAfterPrint.call(window, event);
          } catch (err){
            /* noop */
          }
        }
        cleanup();
      };

      if (mediaQueryList){
        if (typeof mediaQueryList.addEventListener === 'function'){
          mediaQueryList.addEventListener('change', mediaListener);
        } else if (typeof mediaQueryList.addListener === 'function'){
          mediaQueryList.addListener(mediaListener);
        }
      }

      fallbackTimer = window.setTimeout(cleanup, 3000);

      requestAnimationFrame(()=>{
        window.print();
      });
    });
  }

  if (btnLearnInfo){
    btnLearnInfo.setAttribute('aria-haspopup', 'dialog');
    btnLearnInfo.setAttribute('aria-expanded', 'false');
    btnLearnInfo.addEventListener('click', ()=>{
      const isOpen = !!learnInfoPopover && learnInfoPopover.classList.contains('show');
      setLearnInfoVisible(!isOpen);
      if (isOpen && btnLearnInfo) btnLearnInfo.focus();
    });
  }

  if (btnLearnInfoClose){
    btnLearnInfoClose.addEventListener('click', ()=>{
      setLearnInfoVisible(false);
      if (btnLearnInfo) btnLearnInfo.focus();
    });
  }

  if (learnInfoPopover){
    learnInfoPopover.addEventListener('click', (event)=>{
      if (event.target === learnInfoPopover){
        setLearnInfoVisible(false);
        if (btnLearnInfo) btnLearnInfo.focus();
      }
    });
  }

  document.addEventListener('keydown', (event)=>{
    if (event.key === 'Escape' && learnInfoPopover && learnInfoPopover.classList.contains('show')){
      setLearnInfoVisible(false);
      if (btnLearnInfo) btnLearnInfo.focus();
    }
  });

  btnReset.onclick = ()=>{
    buildCounters();
    document.querySelectorAll('.matched,.selected,.locked,.dimmed').forEach(el=>el.classList.remove('matched','selected','locked','dimmed'));
    clinicalSelections.clear();
    forceResetTherapyState();
    renderByMode();
    showToast('Reset','mid');
  };

  /* inizializza filtri (vuoti) e primo render */
  prepareFilters();
  renderByMode();
})();
</script>
<script>
(()=>{
  const protocol = window.location?.protocol || '';
  const isHttp = protocol === 'http:' || protocol === 'https:';
  const params = new URLSearchParams(window.location?.search || '');
  const isDev = params.get('dev') === '1';
  const browseInputs = Array.from(document.querySelectorAll('.btn-sfoglia'));
  const dataError = document.getElementById('dataError');
  const toggleBrowse = visible => {
    browseInputs.forEach(input => {
      if (!input) return;
      input.hidden = !visible ? true : false;
    });
  };
  const showBrowse = ()=>toggleBrowse(true);
  const hideBrowse = ()=>toggleBrowse(false);

  const clearDataError = ()=>{
    if (!dataError) return;
    dataError.hidden = true;
    dataError.textContent = '';
  };
  const showDataError = message => {
    if (!dataError) return;
    dataError.hidden = false;
    dataError.textContent = message || 'Impossibile caricare i dati automatici. Usa i pulsanti ‚ÄúSfoglia‚Äù.';
  };

  if (!isHttp){
    showBrowse();
    return;
  }

  const BUILD = document.documentElement?.getAttribute('data-build')
    || String(Math.floor(Date.now() / 1000));
  const makeUrl = path => {
    const url = new URL(path, window.location.href);
    url.searchParams.set('v', BUILD);
    return url.toString();
  };

  if (isDev){
    showBrowse();
  } else {
    hideBrowse();
  }
  clearDataError();

  const matchingUrl = makeUrl('./data/matching.json');
  const clinicalUrl = makeUrl('./data/clinical.json');

  const fetchJson = url => fetch(url, {cache:'no-store'})
    .then(resp => {
      if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`.trim());
      return resp.json();
    });

  Promise.all([fetchJson(matchingUrl), fetchJson(clinicalUrl)])
    .then(([matching, clinical])=>{
      window.DATA_MATCHING = matching;
      window.DATA_CLINICAL = clinical;
      try {
        if (typeof window.initBugDrug === 'function'){
          window.initBugDrug(matching);
        }
        if (typeof window.initImpara === 'function'){
          window.initImpara(matching);
        }
        if (typeof window.initClinica === 'function'){
          window.initClinica(clinical);
        }
        clearDataError();
      } catch (err){
        console.error('Errore inizializzando i dati automatici', err);
        showBrowse();
        showDataError('Errore nell‚Äôinizializzazione dei dati automatici. Usa i pulsanti ‚ÄúSfoglia‚Äù.');
      }
    })
    .catch(err=>{
      console.error('Errore nel caricamento automatico dei dati', err);
      showBrowse();
      showDataError('Impossibile caricare i dati automatici. Usa i pulsanti ‚ÄúSfoglia‚Äù.');
    });
})();
</script>
<script>
(function () {
  const isHttp = location.protocol === 'http:' || location.protocol === 'https:';
  const isDev  = new URLSearchParams(location.search).has('dev');
  if (isHttp && !isDev) {
    var s = document.createElement('script');
    s.defer = true;
    s.src = 'https://static.cloudflareinsights.com/beacon.min.js';
    s.setAttribute('data-cf-beacon', '{"token":"00a2c55a784b42d6a389648ba282e7c4"}');
    document.head.appendChild(s);
  }
})();
</script>
<script>
(function () {
  const isHttp = location.protocol === 'http:' || location.protocol === 'https:';
  const isDev  = new URLSearchParams(location.search).has('dev');
  if (isHttp && !isDev) {
    document.addEventListener('contextmenu', function (e) {
      e.preventDefault(); // blocca il menu tasto destro
    }, { capture: true });
  }
})();
</script>
</body>
</html>
